---
title: "ICES VMS datacall quality check report"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---

```{r, eval=TRUE, echo=FALSE}
library(knitr)

opts_chunk$set(comment=NA,
               warning=FALSE,
               message=FALSE,
               error  =FALSE,
               echo   =FALSE,
               eval   =TRUE,
               fig.align='left',
               tab.align='left')

library(plyr)

library(ggplot2)
library(vmstools)
library(RColorBrewer)
library(doBy)


dataPath                  <- "D:/Repository/WGSFD/"
load(file.path(dataPath,"eurPols.Rdata"))
```
<!------------------------------------------------------------------------------
Data handling
---------------------------------------------------------------------------- -->
```{r, echo=FALSE, results='asis'}
compareSubmission         <- F

#Read in latest submission -->
#ICES_LE                   <- read.csv(file.path(dataPath,"ICES_LE_pt_2016.csv"),stringsAsFactors=F,sep=";")
#ICES_VE                   <- read.csv(file.path(dataPath,"ICES_VMS_pt_2016.csv"),stringsAsFactors=F,sep=";")
load(file.path(dataPath,"PRT_LOG_2016.RData"))
load(file.path(dataPath,"PRT_VMS_2016.RData"))

#Read in previous submission (P) -->
#if(compareSubmission){
#  ICES_LEP                <- read.csv(file.path(dataPath,"log_ISP.csv",stringsAsFactors=F)
#  ICES_VEP                <- read.csv(file.path(dataPath,"VMS_ISP.csv",stringsAsFactors=F)
#}
```
<!------------------------------------------------------------------------------
Pre-calculations
---------------------------------------------------------------------------- -->

<!--------------------------
Checks for VMS data
------------------------ -->
```{r, echo=FALSE, results='asis'}
#Most recent submission -->
country                   <- unique(ICES_VE$country)
rows_VE                   <- nrow(ICES_VE)
csquares_count_VE         <- length(unique(ICES_VE$c_square))
metier_count_VE           <- length(unique(ICES_VE$LE_MET_level6))
avg_fishing_speed_min_VE  <- min(ICES_VE$avg_fishing_speed,na.rm=T)
avg_fishing_speed_max_VE  <- max(ICES_VE$avg_fishing_speed,na.rm=T)
fishing_hour_sum_VE       <- round(sum(ICES_VE$fishing_hour,na.rm=T), digits=1)
fishing_hour_min_VE       <- round(min(ICES_VE$fishing_hour,na.rm=T), digits=1)
fishing_hour_max_VE       <- round(max(ICES_VE$fishing_hour,na.rm=T), digits=1)
avg_oal_min_VE            <- min(ICES_VE$avg_oal,na.rm=T)
avg_oal_max_VE            <- max(ICES_VE$avg_oal,na.rm=T)
avg_kw_min_VE             <- min(ICES_VE$kw,na.rm=T)
avg_kw_max_VE             <- max(ICES_VE$kw,na.rm=T)
kw_fishinghour_sum_VE     <- round(sum(ICES_VE$kw_fishinghours,na.rm=T), digits=1)
kw_fishinghour_min_VE     <- round(min(ICES_VE$kw_fishinghours,na.rm=T), digits=1)
kw_fishinghour_max_VE     <- round(max(ICES_VE$kw_fishinghours,na.rm=T), digits=1)
totweight_min_VE          <- round(min(ICES_VE$totweight,na.rm=T), digits=1)
totweight_max_VE          <- round(max(ICES_VE$totweight,na.rm=T), digits=1)
mean_landing_per_fishing_hour_VE <- round(with(ICES_VE,sum(ICES_VE$totweight)/sum(ICES_VE$fishing_hour)),digits=1)
ICES_VE$totvalue          <- ifelse(class(ICES_VE$totvalue) != "numeric",NA,ICES_VE$totvalue)
totvalue_min_VE           <- round(min(ICES_VE$totvalue, na.rm=TRUE), digits=1)
totvalue_max_VE           <- round(max(ICES_VE$totvalue, na.rm=TRUE), digits=1)
mean_price_VE             <- round(mean(ICES_VE$totvalue, na.rm=TRUE)/mean(ICES_VE$totweight, na.rm=TRUE), digits=2)
ICES_VE                   <- cbind(ICES_VE,CSquare2LonLat(ICES_VE$c_square,degrees=0.05))
spatBound                 <- list(xrange=range(ICES_VE$SI_LONG,na.rm=T),yrange=range(ICES_VE$SI_LATI,na.rm=T))
tempBound                 <- range(ICES_VE$year,na.rm=T)

#Previous submission -->
if(compareSubmission){
  rows_VEP                <- nrow(ICES_VEP)
  csquares_count_VEP      <- length(unique(ICES_VEP$c_square))
  metier_count_VEP        <- length(unique(ICES_VEP$LE_MET_level6))
  fishing_hour_sum_VEP    <- round(sum(ICES_VEP$fishing_hour,na.rm=T), digits=1)
  totweight_min_VEP       <- round(min(ICES_VEP$totweight,na.rm=T), digits=1)
  totweight_max_VEP       <- round(max(ICES_VEP$totweight,na.rm=T), digits=1)
  mean_landing_per_fishing_hour_VEP <- round(with(ICES_VEP,sum(ICES_VEP$totweight)/sum(ICES_VEP$fishing_hour)),digits=1)
  totvalue_min_VEP        <- round(min(ICES_VEP$totvalue, na.rm=TRUE), digits=1)
  totvalue_max_VEP        <- round(max(ICES_VEP$totvalue, na.rm=TRUE), digits=1)
  mean_price_VEP          <- round(mean(ICES_VEP$totvalue, na.rm=TRUE)/mean(ICES_VEP$totweight, na.rm=TRUE), digits=2)
}
```
<!--------------------------
Checks for logbook data
------------------------ -->
```{r, echo=FALSE, results='asis'}
#Most recent submission -->
rows_LE                   <- nrow(ICES_LE)
years_LE                  <- unique(ICES_LE$year)
months_LE                 <- unique(ICES_LE$month)
vessel_length_category_LE <- unique(ICES_LE$vessel_length_category)
gear_LE                   <- sort(unique(ICES_LE$gear_code))
metier_count_LE           <- length(unique(ICES_LE$LE_MET_level6))
metier_LE                 <- head(unique(ICES_LE$LE_MET_level6),5)
Number_ICES_rectangles_LE <- length(unique(ICES_LE$ICES_rectangle))
ICES_rectangles_LE        <- head(unique(ICES_LE$ICES_rectangle),5)
fishing_days_sum_LE       <- round(sum(ICES_LE$fishing_days,na.rm=T), digits=1)
fishing_days_min_LE       <- round(min(ICES_LE$fishing_days,na.rm=T), digits=1)
fishing_days_max_LE       <- round(max(ICES_LE$fishing_days,na.rm=T), digits=1)
kw_fishing_days_sum_LE    <- round(sum(an(ICES_LE$kw_fishing_days), na.rm=TRUE), digits=1)
kw_fishing_days_min_LE    <- round(min(an(ICES_LE$kw_fishing_days), na.rm=TRUE), digits=1)
kw_fishing_days_max_LE    <- round(max(an(ICES_LE$kw_fishing_days), na.rm=TRUE), digits=1)
totweight_min_LE          <- round(min(an(ICES_LE$totweight),na.rm=T), digits=1)
totweight_max_LE          <- round(max(an(ICES_LE$totweight),na.rm=T), digits=1)
mean_landings_per_day_LE  <- round(with(subset(ICES_LE,!is.na(ICES_LE$fishing_days)),sum(as.numeric(ICES_LE$totweigh))/sum(ICES_LE$fishing_days)), digits=1)
ICES_LE$totvalue          <- ifelse(class(ICES_LE$totvalue) != "numeric",NA,ICES_LE$totvalue)
totvalue_min_LE           <- round(min(an(ICES_LE$totvalue), na.rm=TRUE), digits=1)
totvalue_max_LE           <- round(max(an(ICES_LE$totvalue), na.rm=TRUE), digits=1)
mean_price_LE             <- round(mean(an(ICES_LE$totvalue), na.rm=TRUE)/mean(ICES_LE$totweight, na.rm=TRUE), digits=2)
ICES_LE                   <- cbind(ICES_LE,ICESrectangle2LonLat(ICES_LE$ICES_rectangle,midpoint=T))
spatBoundLog              <- list(xrange=range(ICES_LE$SI_LONG,na.rm=T),yrange=range(ICES_LE$SI_LATI,na.rm=T))
tempBoundLog              <- range(ICES_LE$year,na.rm=T)


#Previous submission -->
if(compareSubmission){
  years_LEP               <- unique(ICES_LEP$year)
  months_LEP              <- unique(ICES_LEP$month)
  vessel_LEPngth_category_LEP <- unique(ICES_LEP$vessel_LEPngth_category)
  gear_LEP                <- sort(unique(ICES_LEP$gear_code))
  metier_count_LEP        <- length(unique(ICES_LEP$LE_MET_LEPvel6))
  fishing_days_sum_LEP    <- round(sum(ICES_LEP$fishing_days,na.rm=T), digits=1)
  kw_fishing_days_sum_LEP <- round(sum(ICES_LEP$kw_fishing_days, na.rm=TRUE), digits=1)
  totweight_min_LEP       <- round(min(ICES_LEP$totweight,na.rm=T), digits=1)
  totweight_max_LEP       <- round(max(ICES_LEP$totweight,na.rm=T), digits=1)
  mean_landings_per_day_LEP <- round(with(subset(ICES_LEP,!is.na(ICES_LEP$fishing_days)),sum(as.numeric(ICES_LEP$totweigh))/sum(ICES_LEP$fishing_days)), digits=1)
  totvalue_min_LEP        <- round(min(ICES_LEP$totvalue, na.rm=TRUE), digits=1)
  totvalue_max_LEP        <- round(max(ICES_LEP$totvalue, na.rm=TRUE), digits=1)
  mean_price_LEP          <- round(mean(ICES_LEP$totvalue, na.rm=TRUE)/mean(ICES_LEP$totweight, na.rm=TRUE), digits=2)
}

```

<!------------------------------------------------------------------------------
Tables & Figures VMS
---------------------------------------------------------------------------- -->

# Quality of the VMS data from `r country`
## Years & number of records for which data has been submitted:
```{r, echo=FALSE, results='asis'}
kable(count(ICES_VE,'year'))

dat2plot <- data.frame(table(ICES_VE$year))
colnames(dat2plot) <- c("Year","Freq")
ggplot(dat2plot,aes(x=Year,y=Freq)) +
  geom_bar(stat="identity") + xlab("Year") + ylab("Number of records") +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              axis.line = element_line(colour = "black"),
              panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Distribution of pings by month:
```{r, echo=FALSE, results='asis'}
kable(table(ICES_VE$month,ICES_VE$year))

qplot(factor(year),data=ICES_VE, geom="bar",fill=factor(month)) +
  xlab("Years") + ylab ("Count") + scale_fill_grey(guide=guide_legend(title="Month")) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Area extend of data submitted by year:
```{r, echo=FALSE, results='asis'}
dat2tab <- as.matrix(aggregate(ICES_VE$SI_LONG,by=list(ICES_VE$year),FUN=range))
dat2tab <- cbind(dat2tab,as.matrix(aggregate(ICES_VE$SI_LATI,by=list(ICES_VE$year),FUN=range)[,-1]))
colnames(dat2tab) <- c("Year","min lon","max lon","min lat","max lat")
kable(dat2tab)
```

## Area for which data has been submitted:
```{r, echo=FALSE, results='asis'}
polLand         <- fortify(eurPols)
polLand         <- subset(polLand,long >= spatBound$xrange[1] & long <= spatBound$xrange[2] &
                                   lat >= spatBound$yrange[1] & lat  <= spatBound$yrange[2])
coordGrd        <- unique(ICES_VE[,c("SI_LONG","SI_LATI","year")])
grdAll          <- lonLat2SpatialPolygons(lst=lapply(as.list(1:nrow(coordGrd)),
                                          function(x){data.frame(SI_LONG=c(coordGrd[x,"SI_LONG"]-0.05/2,rep(coordGrd[x,"SI_LONG"]+0.05/2,2),coordGrd[x,"SI_LONG"]-0.05/2),
                                                                 SI_LATI=c(rep(coordGrd[x,"SI_LATI"]-0.05/2,2),rep(coordGrd[x,"SI_LATI"]+0.05/2,2)))}))
polVMS          <- fortify(grdAll)
polVMS$year     <- rep(coordGrd$year,each=5)
polVMS$cols     <- "red"

                                   
ggplot(polLand,aes(long,lat)) +
  geom_polygon(aes(group=group)) +
  coord_fixed(ratio=lonLatRatio(mean(spatBound$xrange),mean(spatBound$yrange)),xlim=spatBound$xrange, ylim=spatBound$yrange) +
  geom_polygon(data=polVMS,aes(long,lat,group=group,fill=cols)) +
  geom_polygon(data=polLand,aes(long,lat,group=group)) +
  facet_wrap(~year,ncol=2) +
  labs(x = "Longitude", y = "Latitude") +
  theme(axis.text.y   = element_text(colour="black"),
        axis.text.x   = element_text(colour="black"),
        axis.title.y  = element_text(size=14,face="bold"),
        axis.title.x  = element_text(size=14,face="bold"),
        legend.position = "none",
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Frequency of vessel length categories by year:
```{r, echo=FALSE, results='asis'} 
kable(table(ICES_VE$vessel_length_category,ICES_VE$year))

qplot(factor(year),data=ICES_VE, geom="bar",fill=factor(vessel_length_category)) +
  xlab("Years") + ylab ("Count") + scale_fill_grey(guide=guide_legend(title="Length category")) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Frequency of gear codes by year:
```{r, echo=FALSE, results='asis'} 
kable(table(ICES_VE$gear_code,ICES_VE$year))

qplot(factor(year),data=ICES_VE, geom="bar",fill=factor(gear_code)) +
  xlab("Years") + ylab ("Count") + scale_fill_grey(guide=guide_legend(title="Gear code")) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Spatial extend of 3 most dominant gears:
```{r, echo=FALSE, results='asis'}
top3gears <- orderBy(~x,data=aggregate(ICES_VE$fishing_hours,by=list(ICES_VE$gear_code),FUN=sum,na.rm=T))$Group.1[1:3]

polLand         <- fortify(eurPols)
spatCore        <- list(xrange=quantile(ICES_VE$SI_LONG,probs=c(0.025,0.975)),
                        yrange=quantile(ICES_VE$SI_LATI,probs=c(0.025,0.975)))
polLand         <- subset(polLand,long >= spatCore$xrange[1] & long <= spatCore$xrange[2] &
                                   lat >= spatCore$yrange[1] & lat  <= spatCore$yrange[2])
idx             <- which(ICES_VE$gear_code %in% top3gears)
coordGrd        <- unique(ICES_VE[idx,c("SI_LONG","SI_LATI","year","c_square","gear_code")])
grdAll          <- lonLat2SpatialPolygons(lst=lapply(as.list(1:nrow(coordGrd)),
                                          function(x){data.frame(SI_LONG=c(coordGrd[x,"SI_LONG"]-0.05/2,rep(coordGrd[x,"SI_LONG"]+0.05/2,2),coordGrd[x,"SI_LONG"]-0.05/2),
                                                                 SI_LATI=c(rep(coordGrd[x,"SI_LATI"]-0.05/2,2),rep(coordGrd[x,"SI_LATI"]+0.05/2,2)))}))
polVMS          <- fortify(grdAll)
polVMS$year     <- rep(coordGrd$year,each=5)
polVMS$c_square <- rep(coordGrd$c_square,each=5)
polVMS$gear_code<- rep(coordGrd$gear_code,each=5)
dat             <- aggregate(ICES_VE$fishing_hours[idx],by=list(ICES_VE$year[idx],ICES_VE$c_square[idx],ICES_VE$gear_code[idx]),FUN=sum,na.rm=T)

steps               <- ceiling(max(dat$x,na.rm=T)/250/24)
cutbreaksval        <- c(-1,0,steps*c(1,2.5,5,10,25,50,100,250))
legval              <- outer(ac(cutbreaksval),ac(cutbreaksval),function(x,y){return(paste(x,"<=",y))})
legval              <- c("0",diag(legval[-1,-c(1,2)]))
colintens           <- brewer.pal(length(cutbreaksval)-2,"YlOrRd")  #colour for fishing intensity
cols                <- c("white",colintens)[cut(dat$x/24,breaks=cutbreaksval)]
cols                <- cbind(cols,id=1:length(cols),year=dat$Group.1,c_square=dat$Group.2,gear_code=dat$Group.3)
polVMS              <- merge(polVMS,cols,by=c("year","c_square","gear_code"))

ggplot(polLand,aes(long,lat)) +
  geom_polygon(aes(group=group)) +
  coord_fixed(ratio=lonLatRatio(mean(spatCore$xrange),mean(spatCore$yrange)),xlim=spatCore$xrange, ylim=spatCore$yrange) +
  guides(fill=guide_legend(title="Days@Sea")) +
  geom_polygon(data=subset(polVMS,gear_code==top3gears[1]),aes(long,lat,group=group,fill=cols)) +
  scale_fill_manual(values = c(colorRampPalette(rev(brewer.pal(length(cutbreaksval)-2,"YlOrRd")))(length(cutbreaksval)-2),"white"),labels=rev(legval)) +
  geom_polygon(data=subset(polVMS,gear_code==top3gears[1]),aes(long,lat,group=group,fill=cols)) +
  geom_polygon(data=polLand,aes(long,lat,group=group)) +
  facet_wrap(~year*gear_code,ncol=2) +
  labs(x = "Longitude", y = "Latitude") +
  theme(axis.text.y   = element_text(colour="black"),
        axis.text.x   = element_text(colour="black"),
        axis.title.y  = element_text(size=14,face="bold"),
        axis.title.x  = element_text(size=14,face="bold"),
        legend.position="top",
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

```{r, echo=FALSE, results='asis'}
ggplot(polLand,aes(long,lat)) +
  geom_polygon(aes(group=group)) +
  coord_fixed(ratio=lonLatRatio(mean(spatCore$xrange),mean(spatCore$yrange)),xlim=spatCore$xrange, ylim=spatCore$yrange) +
  guides(fill=guide_legend(title="Days@Sea")) +
  geom_polygon(data=subset(polVMS,gear_code==top3gears[2]),aes(long,lat,group=group,fill=cols)) +
  scale_fill_manual(values = c(colorRampPalette(rev(brewer.pal(length(cutbreaksval)-2,"YlOrRd")))(length(cutbreaksval)-2),"white"),labels=rev(legval)) +
  geom_polygon(data=subset(polVMS,gear_code==top3gears[2]),aes(long,lat,group=group,fill=cols)) +
  geom_polygon(data=polLand,aes(long,lat,group=group)) +
  facet_wrap(~year*gear_code,ncol=2) +
  labs(x = "Longitude", y = "Latitude") +
  theme(axis.text.y   = element_text(colour="black"),
        axis.text.x   = element_text(colour="black"),
        axis.title.y  = element_text(size=14,face="bold"),
        axis.title.x  = element_text(size=14,face="bold"),
        legend.position="top",
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage
        
```{r, echo=FALSE, results='asis'}
ggplot(polLand,aes(long,lat)) +
  geom_polygon(aes(group=group)) +
  coord_fixed(ratio=lonLatRatio(mean(spatCore$xrange),mean(spatCore$yrange)),xlim=spatCore$xrange, ylim=spatCore$yrange) +
  guides(fill=guide_legend(title="Days@Sea")) +
  geom_polygon(data=subset(polVMS,gear_code==top3gears[3]),aes(long,lat,group=group,fill=cols)) +
  scale_fill_manual(values = c(colorRampPalette(rev(brewer.pal(length(cutbreaksval)-2,"YlOrRd")))(length(cutbreaksval)-2),"white"),labels=rev(legval)) +
  geom_polygon(data=subset(polVMS,gear_code==top3gears[3]),aes(long,lat,group=group,fill=cols)) +
  geom_polygon(data=polLand,aes(long,lat,group=group)) +
  facet_wrap(~year*gear_code,ncol=2) +
  labs(x = "Longitude", y = "Latitude") +
  theme(axis.text.y   = element_text(colour="black"),
        axis.text.x   = element_text(colour="black"),
        axis.title.y  = element_text(size=14,face="bold"),
        axis.title.x  = element_text(size=14,face="bold"),
        legend.position="top",
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage


## Number of unique DCF Level 6 codes by year:
```{r, echo=FALSE, results='asis'}
kable(count(unique(ICES_VE[,c("LE_MET_level6","year")]),"year"))
```

Top 5 DCF Level 6 codes by year:
```{r, echo=FALSE, results='asis'} 
top5Met6 <- names(rev(sort(table(ICES_VE$LE_MET_level6)))[1:5])
kable(table(ICES_VE$LE_MET_level6,ICES_VE$year)[top5Met6,])

qplot(factor(year),data=subset(ICES_VE,LE_MET_level6 %in% top5Met6), geom="bar",fill=factor(LE_MET_level6)) +
  xlab("Years") + ylab ("Count") + scale_fill_grey(guide=guide_legend(title="Level 6")) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Average fishing speed:
```{r, echo=FALSE, results='asis'}
dat2plot  <- ICES_VE[,c("year","avg_fishing_speed")]
dat2plot$avg_fishing_speed <- an(dat2plot$avg_fishing_speed)
ggplot(dat2plot,aes(x=avg_fishing_speed))+
  geom_histogram() +
  xlab("Average fishing speed") + ylab ("Count") +
  facet_wrap(~year,ncol=2) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Average fishing hours:
```{r, echo=FALSE, results='asis'}
dat2plot  <- ICES_VE[,c("year","fishing_hours")]
dat2plot$fishing_hours <- an(dat2plot$fishing_hours)
ggplot(dat2plot,aes(x=fishing_hours))+
  geom_histogram() +
  xlab("Average fishing hours") + ylab ("Count") +
  facet_wrap(~year,ncol=2) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Average length:
```{r, echo=FALSE, results='asis'}
dat2plot  <- ICES_VE[,c("year","avg_oal")]
dat2plot$avg_oal <- an(dat2plot$avg_oal)
ggplot(dat2plot,aes(x=avg_oal))+
  geom_histogram() +
  xlab("Average vessel length") + ylab ("Count") +
  facet_wrap(~year,ncol=2) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Average KW:
```{r, echo=FALSE, results='asis'}
dat2plot  <- ICES_VE[,c("year","avg_kw")]
dat2plot$avg_kw <- an(dat2plot$avg_kw)
ggplot(dat2plot,aes(x=avg_kw))+
  geom_histogram() +
  xlab("Average vessel length") + ylab ("Count") +
  facet_wrap(~year,ncol=2) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Average KW-hours:
```{r, echo=FALSE, results='asis'}
dat2plot  <- ICES_VE[,c("year","kw_fishinghours")]
dat2plot$kw_fishinghours <- an(dat2plot$kw_fishinghours)
ggplot(dat2plot,aes(x=kw_fishinghours))+
  geom_histogram() +
  xlab("Average KW-hours") + ylab ("Count") +
  facet_wrap(~year,ncol=2) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Landings by gear by year:
```{r, echo=FALSE, results='asis'}
dat2tab <- as.matrix(aggregate(ICES_VE$totweight,by=list(ICES_VE$year,ICES_VE$gear_code),FUN=sum))
colnames(dat2tab) <- c("Year","Gear_code","KG_landed")
dat2tab <- as.data.frame(orderBy(~Year,data=dat2tab),stringsAsFactors=F)
dat2tab$KG_landed <- an(dat2tab$KG_landed)
dat2tab <- acast(dat2tab,Year ~ Gear_code,value.var="KG_landed")
kable(dat2tab)

dat2plot  <- melt(dat2tab)
colnames(dat2plot) <- c("Year","Gear_code","KG_landed")
dat2plot$cols      <- an(af(dat2plot$Gear_code))

ggplot(dat2plot,aes(x=Year,y=KG_landed)) +
  geom_line(aes(group=Gear_code,colour=Gear_code),lwd=1.5) +
  xlab("Year") + ylab ("KG landed") +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Spatial distribution of effort by year:
```{r, echo=FALSE, results='asis',fig.width = 5.5, fig.height = 9}
polLand         <- fortify(eurPols)
spatCore        <- list(xrange=quantile(ICES_VE$SI_LONG,probs=c(0.025,0.975)),
                        yrange=quantile(ICES_VE$SI_LATI,probs=c(0.025,0.975)))
polLand         <- subset(polLand,long >= spatCore$xrange[1] & long <= spatCore$xrange[2] &
                                   lat >= spatCore$yrange[1] & lat  <= spatCore$yrange[2])
coordGrd        <- unique(ICES_VE[,c("SI_LONG","SI_LATI","year","c_square")])
grdAll          <- lonLat2SpatialPolygons(lst=lapply(as.list(1:nrow(coordGrd)),
                                          function(x){data.frame(SI_LONG=c(coordGrd[x,"SI_LONG"]-0.05/2,rep(coordGrd[x,"SI_LONG"]+0.05/2,2),coordGrd[x,"SI_LONG"]-0.05/2),
                                                                 SI_LATI=c(rep(coordGrd[x,"SI_LATI"]-0.05/2,2),rep(coordGrd[x,"SI_LATI"]+0.05/2,2)))}))
polVMS          <- fortify(grdAll)
polVMS$year     <- rep(coordGrd$year,each=5)
polVMS$c_square <- rep(coordGrd$c_square,each=5)
dat             <- aggregate(ICES_VE$fishing_hours,by=list(ICES_VE$year,ICES_VE$c_square),FUN=sum,na.rm=T)

steps               <- ceiling(max(dat$x,na.rm=T)/250/24)
cutbreaksval        <- c(-1,0,steps*c(1,2.5,5,10,25,50,100,250))
legval              <- outer(ac(cutbreaksval),ac(cutbreaksval),function(x,y){return(paste(x,"<=",y))})
legval              <- c("0",diag(legval[-1,-c(1,2)]))
colintens           <- brewer.pal(length(cutbreaksval)-2,"YlOrRd")  #colour for fishing intensity
cols                <- c("white",colintens)[cut(dat$x/24,breaks=cutbreaksval)]
cols                <- cbind(cols,id=1:length(cols),c_square=dat$Group.2,year=dat$Group.1)
polVMS              <- merge(polVMS,cols,by=c("c_square","year"))

ggplot(polLand,aes(long,lat)) +
  geom_polygon(aes(group=group)) +
  coord_fixed(ratio=lonLatRatio(mean(spatCore$xrange),mean(spatCore$yrange)),xlim=spatCore$xrange, ylim=spatCore$yrange) +
  guides(fill=guide_legend(title="Days@Sea")) +
  geom_polygon(data=polVMS,aes(long,lat,group=group,fill=cols)) +
  scale_fill_manual(values = c(colorRampPalette(rev(brewer.pal(length(cutbreaksval)-2,"YlOrRd")))(length(cutbreaksval)-2),"white"),labels=rev(legval)) +
  geom_polygon(data=polVMS,aes(long,lat,group=group,fill=cols)) +
  geom_polygon(data=polLand,aes(long,lat,group=group)) +
  facet_wrap(~year,ncol=2) +
  labs(x = "Longitude", y = "Latitude") +
  theme(axis.text.y   = element_text(colour="black"),
        axis.text.x   = element_text(colour="black"),
        axis.title.y  = element_text(size=14,face="bold"),
        axis.title.x  = element_text(size=14,face="bold"),
        legend.position="top",
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Spatial difference of effort `r tempBound[1]`:`r (tempBound[2]-1)` vs `r tempBound[2]`
```{r, echo=FALSE, results='asis'}
base            <- subset(ICES_VE,year < (tempBound[2]-1))
recent          <- subset(ICES_VE,year == tempBound[2])
datbase         <- aggregate(base$fishing_hours,by=list(base$c_square,base$year),FUN=sum,na.rm=T)
datbase         <- aggregate(datbase$x,by=list(datbase$Group.1),FUN=median,na.rm=T)
datrecent       <- aggregate(recent$fishing_hours,by=list(recent$c_square),FUN=sum,na.rm=T)
colnames(datbase)    <- c("c_square","fishing_hours_median")
colnames(datrecent)   <- c("c_square","fishing_hours")
dat2plot        <- merge(datbase,datrecent[,c("c_square","fishing_hours")],by=c("c_square"),all=T)
dat2plot$fishing_hours_median[is.na(dat2plot$fishing_hours_median)] <- 0
dat2plot$fishing_hours[is.na(dat2plot$fishing_hours)] <- 0
dat2plot$ratio  <- log10(dat2plot$fishing_hours_median / dat2plot$fishing_hours)
dat2plot        <- cbind(dat2plot,CSquare2LonLat(dat2plot$c_square,degrees=0.05))
dat2plot$ratio[which(is.infinite(dat2plot$ratio) & dat2plot$fishing_hours == 0)] <- 9
dat2plot$ratio[which(is.infinite(dat2plot$ratio) & dat2plot$fishing_hours_median == 0)] <- -9
dat2plot$ratio[is.nan(dat2plot$ratio)] <- 0
grdAll          <- lonLat2SpatialPolygons(lst=lapply(as.list(1:nrow(dat2plot)),
                                          function(x){data.frame(SI_LONG=c(dat2plot[x,"SI_LONG"]-0.05/2,rep(dat2plot[x,"SI_LONG"]+0.05/2,2),dat2plot[x,"SI_LONG"]-0.05/2),
                                                                 SI_LATI=c(rep(dat2plot[x,"SI_LATI"]-0.05/2,2),rep(dat2plot[x,"SI_LATI"]+0.05/2,2)))}))
polVMS          <- fortify(grdAll)
polVMS$c_square <- rep(dat2plot$c_square,each=5)

cutbreaksval        <- log10(rev(c(1e-10,0.5,2/3,0.8,0.952381,1,1.05,1.25,1.5,2,1e10)))
legval              <- c("historic >>","historic> +100%","historic> +50%","historic> +25%","+/-5%","recent> +5%","recent> +25%","recent> +50%","recent> +100%","recent >>")
colintens           <- brewer.pal(length(cutbreaksval)-1,"RdYlBu")  #colour for fishing intensity
cols                <- colintens[cut(dat2plot$ratio,breaks=cutbreaksval)]
cols                <- cbind(cols,c_square=dat2plot$c_square)
polVMS              <- merge(polVMS,cols,by=c("c_square"))

ggplot(polLand,aes(long,lat)) +
  geom_polygon(aes(group=group)) +
  coord_fixed(ratio=lonLatRatio(mean(spatCore$xrange),mean(spatCore$yrange)),xlim=spatCore$xrange, ylim=spatCore$yrange) +
  guides(fill=guide_legend(title="Days@Sea")) +
  geom_polygon(data=polVMS,aes(long,lat,group=group,fill=cols)) +
  scale_fill_manual(values = colorRampPalette(rev(brewer.pal(length(cutbreaksval),"RdYlBu")))(length(cutbreaksval)-1),labels=legval) +
  geom_polygon(data=polVMS,aes(long,lat,group=group,fill=cols)) +
  geom_polygon(data=polLand,aes(long,lat,group=group)) +
  labs(x = "Longitude", y = "Latitude") +
  theme(axis.text.y   = element_text(colour="black"),
        axis.text.x   = element_text(colour="black"),
        axis.title.y  = element_text(size=14,face="bold"),
        axis.title.x  = element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Spatial difference of effort `r tempBound[2]-1` vs `r tempBound[2]`

```{r, echo=FALSE, results='asis'}
base            <- subset(ICES_VE,year == (tempBound[2]-1))
recent          <- subset(ICES_VE,year == tempBound[2])
datbase         <- aggregate(base$fishing_hours,  by=list(base$c_square),  FUN=sum,na.rm=T)
datrecent       <- aggregate(recent$fishing_hours,by=list(recent$c_square),FUN=sum,na.rm=T)
colnames(datbase)    <- c("c_square","fishing_hours_median")
colnames(datrecent)   <- c("c_square","fishing_hours")
dat2plot        <- merge(datbase,datrecent[,c("c_square","fishing_hours")],by=c("c_square"),all=T)
dat2plot$fishing_hours_median[is.na(dat2plot$fishing_hours_median)] <- 0
dat2plot$fishing_hours[is.na(dat2plot$fishing_hours)] <- 0
dat2plot$ratio  <- log10(dat2plot$fishing_hours_median / dat2plot$fishing_hours)
dat2plot        <- cbind(dat2plot,CSquare2LonLat(dat2plot$c_square,degrees=0.05))
dat2plot$ratio[which(is.infinite(dat2plot$ratio) & dat2plot$fishing_hours == 0)] <- 9
dat2plot$ratio[which(is.infinite(dat2plot$ratio) & dat2plot$fishing_hours_median == 0)] <- -9
dat2plot$ratio[is.nan(dat2plot$ratio)] <- 0
grdAll          <- lonLat2SpatialPolygons(lst=lapply(as.list(1:nrow(dat2plot)),
                                          function(x){data.frame(SI_LONG=c(dat2plot[x,"SI_LONG"]-0.05/2,rep(dat2plot[x,"SI_LONG"]+0.05/2,2),dat2plot[x,"SI_LONG"]-0.05/2),
                                                                 SI_LATI=c(rep(dat2plot[x,"SI_LATI"]-0.05/2,2),rep(dat2plot[x,"SI_LATI"]+0.05/2,2)))}))
polVMS          <- fortify(grdAll)
polVMS$c_square <- rep(dat2plot$c_square,each=5)

cutbreaksval        <- log10(rev(c(1e-10,0.5,2/3,0.8,0.952381,1,1.05,1.25,1.5,2,1e10)))
legval              <- c("historic >>","historic> +100%","historic> +50%","historic> +25%","+/-5%","recent> +5%","recent> +25%","recent> +50%","recent> +100%","recent >>")
colintens           <- brewer.pal(length(cutbreaksval)-1,"RdYlBu")  #colour for fishing intensity
cols                <- colintens[cut(dat2plot$ratio,breaks=cutbreaksval)]
cols                <- cbind(cols,c_square=dat2plot$c_square)
polVMS              <- merge(polVMS,cols,by=c("c_square"))

ggplot(polLand,aes(long,lat)) +
  geom_polygon(aes(group=group)) +
  coord_fixed(ratio=lonLatRatio(mean(spatCore$xrange),mean(spatCore$yrange)),xlim=spatCore$xrange, ylim=spatCore$yrange) +
  guides(fill=guide_legend(title="Days@Sea")) +
  geom_polygon(data=polVMS,aes(long,lat,group=group,fill=cols)) +
  scale_fill_manual(values = colorRampPalette(rev(brewer.pal(length(cutbreaksval),"RdYlBu")))(length(cutbreaksval)-1),labels=legval) +
  geom_polygon(data=polVMS,aes(long,lat,group=group,fill=cols)) +
  geom_polygon(data=polLand,aes(long,lat,group=group)) +
  labs(x = "Longitude", y = "Latitude") +
  theme(axis.text.y   = element_text(colour="black"),
        axis.text.x   = element_text(colour="black"),
        axis.title.y  = element_text(size=14,face="bold"),
        axis.title.x  = element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Mean landing per KW fishing hours by year:

```{r, echo=FALSE, results='asis'}
dat2tab <- as.matrix(aggregate(ICES_VE$totweight/ICES_VE$kw_fishinghours,by=list(ICES_VE$year,ICES_VE$gear_code),FUN=median))
colnames(dat2tab) <- c("Year","Gear_code","KGkwH")
dat2tab <- as.data.frame(orderBy(~Year,data=dat2tab),stringsAsFactors=F)
dat2tab$KGkwH <- an(dat2tab$KGkwH)
dat2tab <- acast(dat2tab,Year ~ Gear_code,value.var="KGkwH")
kable(dat2tab)

dat2plot  <- melt(dat2tab)
colnames(dat2plot) <- c("Year","Gear_code","KGkwH")
dat2plot$cols      <- an(af(dat2plot$Gear_code))

ggplot(dat2plot,aes(x=Year,y=KGkwH)) +
  geom_line(aes(group=Gear_code,colour=Gear_code),lwd=1.5) +
  xlab("Year") + ylab ("KG/kwH") +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Value by gear by year:
```{r, echo=FALSE, results='asis'}
dat2tab <- as.matrix(aggregate(ICES_VE$totvalue,by=list(ICES_VE$year,ICES_VE$gear_code),FUN=sum))
colnames(dat2tab) <- c("Year","Gear_code","EUR_landed")
dat2tab <- as.data.frame(orderBy(~Year,data=dat2tab),stringsAsFactors=F)
dat2tab$EUR_landed <- an(dat2tab$EUR_landed)
dat2tab <- acast(dat2tab,Year ~ Gear_code,value.var="EUR_landed")
kable(dat2tab)

dat2plot  <- melt(dat2tab)
colnames(dat2plot) <- c("Year","Gear_code","EUR_landed")
dat2plot$cols      <- an(af(dat2plot$Gear_code))

ggplot(dat2plot,aes(x=Year,y=EUR_landed)) +
  geom_line(aes(group=Gear_code,colour=Gear_code),lwd=1.5) +
  xlab("Year") + ylab ("EUR landed") +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Mean value per KW fishing hours by year:

```{r, echo=FALSE, results='asis'}
dat2tab <- as.matrix(aggregate(ICES_VE$totvalue/ICES_VE$kw_fishinghours,by=list(ICES_VE$year,ICES_VE$gear_code),FUN=median))
colnames(dat2tab) <- c("Year","Gear_code","EURkwH")
dat2tab <- as.data.frame(orderBy(~Year,data=dat2tab),stringsAsFactors=F)
dat2tab$EURkwH <- an(dat2tab$EURkwH)
dat2tab <- acast(dat2tab,Year ~ Gear_code,value.var="EURkwH")
kable(dat2tab)

dat2plot  <- melt(dat2tab)
colnames(dat2plot) <- c("Year","Gear_code","EURkwH")
dat2plot$cols      <- an(af(dat2plot$Gear_code))

ggplot(dat2plot,aes(x=Year,y=EURkwH)) +
  geom_line(aes(group=Gear_code,colour=Gear_code),lwd=1.5) +
  xlab("Year") + ylab ("EUR/kwH") +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

##  Average price:

```{r, echo=FALSE, results='asis'}
  dat2plot  <- aggregate(ICES_VE$totvalue/ICES_VE$totweight,by=list(ICES_VE$year),FUN=median)
  dat2plot$x <- an(dat2plot$x)
  colnames(dat2plot) <- c("Year","MeanPrice")
  ggplot(dat2plot,aes(x=Year,y=MeanPrice))+
    geom_line(lwd=1.5) +
    xlab("Year") + ylab ("EUR/kwH") +
    theme(axis.title=element_text(size=14,face="bold"),
          panel.background = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          axis.line = element_line(colour = "black"),
          panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

# Quality of the logbook

## Years & number of records for which data has been submitted:
```{r, echo=FALSE, results='asis'}
kable(count(ICES_LE,'year'))

dat2plot <- data.frame(table(ICES_LE$year))
colnames(dat2plot) <- c("Year","Freq")
ggplot(dat2plot,aes(x=Year,y=Freq)) +
  geom_bar(stat="identity") + xlab("Year") + ylab("Number of records") +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              axis.line = element_line(colour = "black"),
              panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Distribution of pings by month:
```{r, echo=FALSE, results='asis'}
kable(table(ICES_LE$month,ICES_LE$year))

qplot(factor(year),data=ICES_LE, geom="bar",fill=factor(month)) +
  xlab("Years") + ylab ("Count") + scale_fill_grey(guide=guide_legend(title="Month")) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Area extend of data submitted by year:
```{r, echo=FALSE, results='asis'}
dat2tab <- as.matrix(aggregate(ICES_LE$SI_LONG,by=list(ICES_LE$year),FUN=range))
dat2tab <- cbind(dat2tab,as.matrix(aggregate(ICES_LE$SI_LATI,by=list(ICES_LE$year),FUN=range)[,-1]))
colnames(dat2tab) <- c("Year","min lon","max lon","min lat","max lat")
kable(dat2tab)
```

## Area for which data has been submitted:
```{r, echo=FALSE, results='asis'}
polLand         <- fortify(eurPols)
polLand         <- subset(polLand,long >= spatBoundLog$xrange[1] & long <= spatBoundLog$xrange[2] &
                                   lat >= spatBoundLog$yrange[1] & lat  <= spatBoundLog$yrange[2])
coordGrd        <- unique(ICES_LE[,c("SI_LONG","SI_LATI","year")])
grdAll          <- lonLat2SpatialPolygons(lst=lapply(as.list(1:nrow(coordGrd)),
                                          function(x){data.frame(SI_LONG=c(coordGrd[x,"SI_LONG"]-1/2,rep(coordGrd[x,"SI_LONG"]+1/2,2),coordGrd[x,"SI_LONG"]-1/2),
                                                                 SI_LATI=c(rep(coordGrd[x,"SI_LATI"]-0.5/2,2),rep(coordGrd[x,"SI_LATI"]+0.5/2,2)))}))
polRect         <- fortify(grdAll)
polRect$year    <- rep(coordGrd$year,each=5)
polRect$cols    <- "red"


ggplot(polLand,aes(long,lat)) +
  geom_polygon(aes(group=group)) +
  coord_fixed(ratio=lonLatRatio(mean(spatBoundLog$xrange),mean(spatBoundLog$yrange)),xlim=spatBoundLog$xrange, ylim=spatBoundLog$yrange) +
  geom_polygon(data=polRect,aes(long,lat,group=group,fill=cols)) +
  geom_polygon(data=polLand,aes(long,lat,group=group)) +
  facet_wrap(~year,ncol=2) +
  labs(x = "Longitude", y = "Latitude") +
  theme(axis.text.y   = element_text(colour="black"),
        axis.text.x   = element_text(colour="black"),
        axis.title.y  = element_text(size=14,face="bold"),
        axis.title.x  = element_text(size=14,face="bold"),
        legend.position = "none",
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Frequency of vessel length categories by year:
```{r, echo=FALSE, results='asis'}
kable(table(ICES_LE$vessel_length_category,ICES_LE$year))

qplot(factor(year),data=ICES_LE, geom="bar",fill=factor(vessel_length_category)) +
  xlab("Years") + ylab ("Count") + scale_fill_grey(guide=guide_legend(title="Length category")) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Frequency of gear codes by year:
```{r, echo=FALSE, results='asis'}
kable(table(ICES_LE$gear_code,ICES_LE$year))

qplot(factor(year),data=ICES_LE, geom="bar",fill=factor(gear_code)) +
  xlab("Years") + ylab ("Count") + scale_fill_grey(guide=guide_legend(title="Gear code")) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Number of unique DCF Level 6 codes by year:
```{r, echo=FALSE, results='asis'}
kable(count(unique(ICES_LE[,c("LE_MET_level6","year")]),"year"))
```

## Top 5 DCF Level 6 codes by year:
```{r, echo=FALSE, results='asis'}
top5Met6 <- names(rev(sort(table(ICES_LE$LE_MET_level6)))[1:5])
kable(table(ICES_LE$LE_MET_level6,ICES_LE$year)[top5Met6,])

qplot(factor(year),data=subset(ICES_LE,LE_MET_level6 %in% top5Met6), geom="bar",fill=factor(LE_MET_level6)) +
  xlab("Years") + ylab ("Count") + scale_fill_grey(guide=guide_legend(title="Level 6")) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Frequency of VMS enabled category
```{r, echo=FALSE, results='asis'}
kable(table(ICES_LE$vms_enabled,ICES_LE$vessel_length_category))
```

## Average fishing days:
```{r, echo=FALSE, results='asis'}
dat2plot  <- ICES_LE[,c("year","fishing_days")]
dat2plot$fishing_hours <- an(dat2plot$fishing_days)
ggplot(dat2plot,aes(x=fishing_days))+
  geom_histogram() +
  xlab("Average fishing days") + ylab ("Count") +
  facet_wrap(~year,ncol=2) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Average KW-hours:
```{r, echo=FALSE, results='asis'}
dat2plot  <- ICES_LE[,c("year","kw_fishing_days")]
dat2plot$kw_fishing_days <- an(dat2plot$kw_fishing_days)
ggplot(dat2plot,aes(x=kw_fishing_days))+
  geom_histogram() +
  xlab("Average KW-days") + ylab ("Count") +
  facet_wrap(~year,ncol=2) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Landings by gear by year:
```{r, echo=FALSE, results='asis'}
dat2tab <- as.matrix(aggregate(ICES_LE$totweight,by=list(ICES_LE$year,ICES_LE$gear_code),FUN=sum))
colnames(dat2tab) <- c("Year","Gear_code","KG_landed")
dat2tab <- as.data.frame(orderBy(~Year,data=dat2tab),stringsAsFactors=F)
dat2tab$KG_landed <- an(dat2tab$KG_landed)
dat2tab <- acast(dat2tab,Year ~ Gear_code,value.var="KG_landed")
kable(dat2tab)

dat2plot  <- melt(dat2tab)
colnames(dat2plot) <- c("Year","Gear_code","KG_landed")
dat2plot$cols      <- an(af(dat2plot$Gear_code))

ggplot(dat2plot,aes(x=Year,y=KG_landed)) +
  geom_line(aes(group=Gear_code,colour=Gear_code),lwd=1.5) +
  xlab("Year") + ylab ("KG landed") +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Spatial distribution of effort by year:
```{r, echo=FALSE, results='asis',fig.width = 5.5, fig.height = 9}
polLand         <- fortify(eurPols)
spatCore        <- list(xrange=quantile(ICES_LE$SI_LONG,probs=c(0.025,0.975)),
                        yrange=quantile(ICES_LE$SI_LATI,probs=c(0.025,0.975)))
polLand         <- subset(polLand,long >= spatCore$xrange[1] & long <= spatCore$xrange[2] &
                                   lat >= spatCore$yrange[1] & lat  <= spatCore$yrange[2])
coordGrd        <- unique(ICES_LE[,c("SI_LONG","SI_LATI","year","ICES_rectangle")])
grdAll          <- lonLat2SpatialPolygons(lst=lapply(as.list(1:nrow(coordGrd)),
                                          function(x){data.frame(SI_LONG=c(coordGrd[x,"SI_LONG"]-1/2,rep(coordGrd[x,"SI_LONG"]+1/2,2),coordGrd[x,"SI_LONG"]-1/2),
                                                                 SI_LATI=c(rep(coordGrd[x,"SI_LATI"]-0.5/2,2),rep(coordGrd[x,"SI_LATI"]+0.5/2,2)))}))
polRect         <- fortify(grdAll)
polRect$year    <- rep(coordGrd$year,each=5)
polRect$ICES_rectangle <- rep(coordGrd$ICES_rectangle,each=5)
dat             <- aggregate(ICES_LE$fishing_days,by=list(ICES_LE$year,ICES_LE$ICES_rectangle),FUN=sum,na.rm=T)

steps               <- ceiling(max(dat$x,na.rm=T)/250)
cutbreaksval        <- c(-1,0,steps*c(1,2.5,5,10,25,50,100,250))
legval              <- outer(ac(cutbreaksval),ac(cutbreaksval),function(x,y){return(paste(x,"<=",y))})
legval              <- c("0",diag(legval[-1,-c(1,2)]))
colintens           <- brewer.pal(length(cutbreaksval)-2,"YlOrRd")  #colour for fishing intensity
cols                <- c("white",colintens)[cut(dat$x,breaks=cutbreaksval)]
cols                <- cbind(cols,id=1:length(cols),ICES_rectangle=dat$Group.2,year=dat$Group.1)
polRect              <- merge(polRect,cols,by=c("ICES_rectangle","year"))

ggplot(polLand,aes(long,lat)) +
  geom_polygon(aes(group=group)) +
  coord_fixed(ratio=lonLatRatio(mean(spatCore$xrange),mean(spatCore$yrange)),xlim=spatCore$xrange, ylim=spatCore$yrange) +
  guides(fill=guide_legend(title="Days@Sea")) +
  geom_polygon(data=polRect,aes(long,lat,group=group,fill=cols)) +
  scale_fill_manual(values = c(colorRampPalette(rev(brewer.pal(length(cutbreaksval)-2,"YlOrRd")))(length(cutbreaksval)-2),"white"),labels=rev(legval)) +
  geom_polygon(data=polRect,aes(long,lat,group=group,fill=cols)) +
  geom_polygon(data=polLand,aes(long,lat,group=group)) +
  facet_wrap(~year,ncol=2) +
  labs(x = "Longitude", y = "Latitude") +
  theme(axis.text.y   = element_text(colour="black"),
        axis.text.x   = element_text(colour="black"),
        axis.title.y  = element_text(size=14,face="bold"),
        axis.title.x  = element_text(size=14,face="bold"),
        legend.position="top",
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Spatial difference of effort `r tempBound[1]`:`r (tempBound[2]-1)` vs `r tempBound[2]`
```{r, echo=FALSE, results='asis'}
base            <- subset(ICES_LE,year < (tempBoundLog[2]-1))
recent          <- subset(ICES_LE,year == tempBoundLog[2])
datbase         <- aggregate(base$fishing_days,by=list(base$ICES_rectangle,base$year),FUN=sum,na.rm=T)
datbase         <- aggregate(datbase$x,by=list(datbase$Group.1),FUN=median,na.rm=T)
datrecent       <- aggregate(recent$fishing_days,by=list(recent$ICES_rectangle),FUN=sum,na.rm=T)
colnames(datbase)    <- c("ICES_rectangle","fishing_days_median")
colnames(datrecent)   <- c("ICES_rectangle","fishing_days")
dat2plot        <- merge(datbase,datrecent[,c("ICES_rectangle","fishing_days")],by=c("ICES_rectangle"),all=T)
dat2plot$fishing_days_median[is.na(dat2plot$fishing_days_median)] <- 0
dat2plot$fishing_days[is.na(dat2plot$fishing_days)] <- 0
dat2plot$ratio  <- log10(dat2plot$fishing_days_median / dat2plot$fishing_days)
dat2plot        <- cbind(dat2plot,ICESrectangle2LonLat(dat2plot$ICES_rectangle,midpoint=T))
dat2plot$ratio[which(is.infinite(dat2plot$ratio) & dat2plot$fishing_days == 0)] <- 9
dat2plot$ratio[which(is.infinite(dat2plot$ratio) & dat2plot$fishing_days_median == 0)] <- -9
dat2plot$ratio[is.nan(dat2plot$ratio)] <- 0
grdAll          <- lonLat2SpatialPolygons(lst=lapply(as.list(1:nrow(dat2plot)),
                                          function(x){data.frame(SI_LONG=c(dat2plot[x,"SI_LONG"]-1/2,rep(dat2plot[x,"SI_LONG"]+1/2,2),dat2plot[x,"SI_LONG"]-1/2),
                                                                 SI_LATI=c(rep(dat2plot[x,"SI_LATI"]-0.5/2,2),rep(dat2plot[x,"SI_LATI"]+0.5/2,2)))}))
polRect          <- fortify(grdAll)
polRect$ICES_rectangle <- rep(dat2plot$ICES_rectangle,each=5)

cutbreaksval        <- log10(rev(c(1e-10,0.5,2/3,0.8,0.952381,1,1.05,1.25,1.5,2,1e10)))
legval              <- c("historic >>","historic> +100%","historic> +50%","historic> +25%","+/-5%","recent> +5%","recent> +25%","recent> +50%","recent> +100%","recent >>")
colintens           <- brewer.pal(length(cutbreaksval)-1,"RdYlBu")  #colour for fishing intensity
cols                <- colintens[cut(dat2plot$ratio,breaks=cutbreaksval)]
cols                <- cbind(cols,ICES_rectangle=dat2plot$ICES_rectangle)
polRect              <- merge(polRect,cols,by=c("ICES_rectangle"))

  ggplot(polLand,aes(long,lat)) +
    geom_polygon(aes(group=group)) +
    coord_fixed(ratio=lonLatRatio(mean(spatCore$xrange),mean(spatCore$yrange)),xlim=spatCore$xrange, ylim=spatCore$yrange) +
    guides(fill=guide_legend(title="Days@Sea")) +
    geom_polygon(data=polRect,aes(long,lat,group=group,fill=cols)) +
    scale_fill_manual(values = colorRampPalette(rev(brewer.pal(length(cutbreaksval),"RdYlBu")))(length(cutbreaksval)-1),labels=legval) +
    geom_polygon(data=polRect,aes(long,lat,group=group,fill=cols)) +
    geom_polygon(data=polLand,aes(long,lat,group=group)) +
    labs(x = "Longitude", y = "Latitude") +
    theme(axis.text.y   = element_text(colour="black"),
          axis.text.x   = element_text(colour="black"),
          axis.title.y  = element_text(size=14,face="bold"),
          axis.title.x  = element_text(size=14,face="bold"),
          panel.background = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          axis.line = element_line(colour = "black"),
          panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Spatial difference of effort `r tempBound[2]-1` vs `r tempBound[2]`

```{r, echo=FALSE, results='asis'}
base            <- subset(ICES_LE,year == (tempBoundLog[2]-1))
recent          <- subset(ICES_LE,year == tempBoundLog[2])
datbase         <- aggregate(base$fishing_days,  by=list(base$ICES_rectangle),  FUN=sum,na.rm=T)
datrecent       <- aggregate(recent$fishing_days,by=list(recent$ICES_rectangle),FUN=sum,na.rm=T)
colnames(datbase)    <- c("ICES_rectangle","fishing_days_median")
colnames(datrecent)   <- c("ICES_rectangle","fishing_days")
dat2plot        <- merge(datbase,datrecent[,c("ICES_rectangle","fishing_days")],by=c("ICES_rectangle"),all=T)
dat2plot$fishing_days_median[is.na(dat2plot$fishing_days_median)] <- 0
dat2plot$fishing_days[is.na(dat2plot$fishing_days)] <- 0
dat2plot$ratio  <- log10(dat2plot$fishing_days_median / dat2plot$fishing_days)
dat2plot        <- cbind(dat2plot,ICESrectangle2LonLat(dat2plot$ICES_rectangle,midpoint=T))
dat2plot$ratio[which(is.infinite(dat2plot$ratio) & dat2plot$fishing_days == 0)] <- 9
dat2plot$ratio[which(is.infinite(dat2plot$ratio) & dat2plot$fishing_days_median == 0)] <- -9
dat2plot$ratio[is.nan(dat2plot$ratio)] <- 0
grdAll          <- lonLat2SpatialPolygons(lst=lapply(as.list(1:nrow(dat2plot)),
                                          function(x){data.frame(SI_LONG=c(dat2plot[x,"SI_LONG"]-1/2,rep(dat2plot[x,"SI_LONG"]+1/2,2),dat2plot[x,"SI_LONG"]-1/2),
                                                                 SI_LATI=c(rep(dat2plot[x,"SI_LATI"]-0.5/2,2),rep(dat2plot[x,"SI_LATI"]+0.5/2,2)))}))
polRect          <- fortify(grdAll)
polRect$ICES_rectangle <- rep(dat2plot$ICES_rectangle,each=5)

cutbreaksval        <- log10(rev(c(1e-10,0.5,2/3,0.8,0.952381,1,1.05,1.25,1.5,2,1e10)))
legval              <- c("historic >>","historic> +100%","historic> +50%","historic> +25%","+/-5%","recent> +5%","recent> +25%","recent> +50%","recent> +100%","recent >>")
colintens           <- brewer.pal(length(cutbreaksval)-1,"RdYlBu")  #colour for fishing intensity
cols                <- colintens[cut(dat2plot$ratio,breaks=cutbreaksval)]
cols                <- cbind(cols,ICES_rectangle=dat2plot$ICES_rectangle)
polRect              <- merge(polRect,cols,by=c("ICES_rectangle"))

ggplot(polLand,aes(long,lat)) +
  geom_polygon(aes(group=group)) +
  coord_fixed(ratio=lonLatRatio(mean(spatCore$xrange),mean(spatCore$yrange)),xlim=spatCore$xrange, ylim=spatCore$yrange) +
  guides(fill=guide_legend(title="Days@Sea")) +
  geom_polygon(data=polRect,aes(long,lat,group=group,fill=cols)) +
  scale_fill_manual(values = colorRampPalette(rev(brewer.pal(length(cutbreaksval),"RdYlBu")))(length(cutbreaksval)-1),labels=legval) +
  geom_polygon(data=polRect,aes(long,lat,group=group,fill=cols)) +
  geom_polygon(data=polLand,aes(long,lat,group=group)) +
  labs(x = "Longitude", y = "Latitude") +
  theme(axis.text.y   = element_text(colour="black"),
        axis.text.x   = element_text(colour="black"),
        axis.title.y  = element_text(size=14,face="bold"),
        axis.title.x  = element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage


## Relationship fishing days and total weight
```{r, echo=FALSE, results='asis'}
ggplot(subset(ICES_LE,year==tempBoundLog[2]),aes(x=fishing_days,y=totweight)) +
  geom_point() +
  facet_wrap(~gear_code,ncol=2,scale="free") +
  xlab("Fishing days") + ylab ("Total weight") +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Mean landing per KW fishing day by year:

```{r, echo=FALSE, results='asis'}
ICES_LE$kw_fishing_days <- an(ICES_LE$kw_fishing_days)
dat2tab <- as.matrix(aggregate(ICES_LE$totweight/ICES_LE$kw_fishing_days,by=list(ICES_LE$year,ICES_LE$gear_code),FUN=median))
colnames(dat2tab) <- c("Year","Gear_code","KGkwH")
dat2tab <- as.data.frame(orderBy(~Year,data=dat2tab),stringsAsFactors=F)
dat2tab$KGkwH <- an(dat2tab$KGkwH)
dat2tab <- acast(dat2tab,Year ~ Gear_code,value.var="KGkwH")
kable(dat2tab)

dat2plot  <- melt(dat2tab)
colnames(dat2plot) <- c("Year","Gear_code","KGkwH")
dat2plot$cols      <- an(af(dat2plot$Gear_code))

ggplot(dat2plot,aes(x=Year,y=KGkwH)) +
  geom_line(aes(group=Gear_code,colour=Gear_code),lwd=1.5) +
  xlab("Year") + ylab ("KG/kwH") +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Value by gear by year:
```{r, echo=FALSE, results='asis'}
ICES_LE$totvalue <- an(ICES_LE$totvalue)
dat2tab <- as.matrix(aggregate(ICES_LE$totvalue,by=list(ICES_LE$year,ICES_LE$gear_code),FUN=sum))
colnames(dat2tab) <- c("Year","Gear_code","EUR_landed")
dat2tab <- as.data.frame(orderBy(~Year,data=dat2tab),stringsAsFactors=F)
dat2tab$EUR_landed <- an(dat2tab$EUR_landed)
dat2tab <- acast(dat2tab,Year ~ Gear_code,value.var="EUR_landed")
kable(dat2tab)

dat2plot  <- melt(dat2tab)
colnames(dat2plot) <- c("Year","Gear_code","EUR_landed")
dat2plot$cols      <- an(af(dat2plot$Gear_code))

ggplot(dat2plot,aes(x=Year,y=EUR_landed)) +
  geom_line(aes(group=Gear_code,colour=Gear_code),lwd=1.5) +
  xlab("Year") + ylab ("EUR landed") +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Mean value per KW fishing day by year:

```{r, echo=FALSE, results='asis'}
dat2tab <- as.matrix(aggregate(ICES_LE$totvalue/ICES_LE$kw_fishing_days,by=list(ICES_LE$year,ICES_LE$gear_code),FUN=median))
colnames(dat2tab) <- c("Year","Gear_code","EURkwH")
dat2tab <- as.data.frame(orderBy(~Year,data=dat2tab),stringsAsFactors=F)
dat2tab$EURkwH <- an(dat2tab$EURkwH)
dat2tab <- acast(dat2tab,Year ~ Gear_code,value.var="EURkwH")
kable(dat2tab)

dat2plot  <- melt(dat2tab)
colnames(dat2plot) <- c("Year","Gear_code","EURkwH")
dat2plot$cols      <- an(af(dat2plot$Gear_code))

ggplot(dat2plot,aes(x=Year,y=EURkwH)) +
  geom_line(aes(group=Gear_code,colour=Gear_code),lwd=1.5) +
  xlab("Year") + ylab ("EUR/kwH") +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

##  Average price:

```{r, echo=FALSE, results='asis'}
  dat2plot  <- aggregate(ICES_LE$totvalue/ICES_LE$totweight,by=list(ICES_LE$year),FUN=median)
  dat2plot$x <- an(dat2plot$x)
  colnames(dat2plot) <- c("Year","MeanPrice")
  ggplot(dat2plot,aes(x=Year,y=MeanPrice))+
    geom_line(lwd=1.5) +
    xlab("Year") + ylab ("EUR/kwH") +
    theme(axis.title=element_text(size=14,face="bold"),
          panel.background = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          axis.line = element_line(colour = "black"),
          panel.border = element_rect(colour = "black", fill=NA))
```


