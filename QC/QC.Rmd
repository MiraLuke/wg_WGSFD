---
title: "ICES VMS datacall quality check report"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---

<!-- QCTEMPLATE: header -->
```{r setup, eval=TRUE, echo=FALSE, cache=FALSE}
library(knitr)

opts_chunk$set(comment   = NA,
               warning   = FALSE,
               message   = FALSE,
               error     = FALSE,
               echo      = FALSE,
               eval      = TRUE,
               dev = "my_png",
               fig.ext = "png",
               fig.align = 'left',
               tab.align = 'left',
               fig.width = 5.5)

my_png <- function(file, width, height) {
  png(file, width = width, height = height, 
      res = 800, units = "in", pointsize = 20)
}

library(plyr)
library(ggplot2)
library(vmstools)
library(RColorBrewer)
library(doBy)
library(reshape2)
```

```{r load-data}
load("POLYGONS/eurPols.Rdata")
```
<!-- QCTEMPLATE: data -->
<!------------------------------------------------------------------------------
Data handling
---------------------------------------------------------------------------- -->
```{r, echo=FALSE, results='asis'}
#Read in latest submission -->
# NOTE:
#   This chunk of code is replaced when a template is created.

dataPath <- "D:/Repository/WGSFD/"
#ICES_LE                   <- read.csv(file.path(dataPath,"ICES_LE_pt_2016.csv"),stringsAsFactors=F,sep=";")
#ICES_VE                   <- read.csv(file.path(dataPath,"ICES_VMS_pt_2016.csv"),stringsAsFactors=F,sep=";")
load(file.path(dataPath,"PRT_LOG_2016.RData"))
load(file.path(dataPath,"PRT_VMS_2016.RData"))

#Read in previous submission (P) -->
#if(compareSubmission){
#  ICES_LEP                <- read.csv(file.path(dataPath,"log_ISP.csv",stringsAsFactors=F)
#  ICES_VEP                <- read.csv(file.path(dataPath,"VMS_ISP.csv",stringsAsFactors=F)
#}
```
<!-- QCTEMPLATE: body -->
<!------------------------------------------------------------------------------
Pre-calculations
---------------------------------------------------------------------------- -->

<!--------------------------
Checks for VMS data
------------------------ -->
```{r vms-checks}
#Most recent submission -->
country <- ICES_VE$country[1]
ICES_VE <- cbind(ICES_VE, CSquare2LonLat(ICES_VE$c_square, degrees=0.05))
spatBound <- list(xrange = range(ICES_VE$SI_LONG, na.rm=TRUE),
                  yrange = range(ICES_VE$SI_LATI, na.rm=TRUE))
tempBound <- range(ICES_VE$year, na.rm=TRUE)
```
<!--------------------------
Checks for logbook data
------------------------ -->
```{r logbook-checks}
#Most recent submission -->
ICES_LE <- cbind(ICES_LE, ICESrectangle2LonLat(ICES_LE$ICES_rectangle, midpoint=TRUE))
spatBoundLog <- list(xrange = range(ICES_LE$SI_LONG, na.rm=TRUE),
                     yrange = range(ICES_LE$SI_LATI, na.rm=TRUE))
tempBoundLog <- range(ICES_LE$year, na.rm=TRUE)
```

<!------------------------------------------------------------------------------
Tables & Figures VMS
---------------------------------------------------------------------------- -->

# Quality of the VMS data from `r country`
## Years & number of records for which data has been submitted:
```{r records-by-year, results='asis'}
kable(count(ICES_VE,'year'))

dat2plot <- data.frame(table(ICES_VE$year))
colnames(dat2plot) <- c("Year","Freq")
ggplot(dat2plot,aes(x=Year,y=Freq)) +
  geom_bar(stat="identity") + xlab("Year") + ylab("Number of records") +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              axis.line = element_line(colour = "black"),
              panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Distribution of pings by month:
```{r pings-by-month}
kable(table(ICES_VE$month,ICES_VE$year))

qplot(factor(year),data=ICES_VE, geom="bar",fill=factor(month)) +
  xlab("Years") + ylab ("Count") + scale_fill_grey(guide=guide_legend(title="Month")) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Spatial extent of data submitted by year:
```{r table-exent, results='asis'}
dat2tab <- as.matrix(aggregate(ICES_VE$SI_LONG,by=list(ICES_VE$year),FUN=range))
dat2tab <- cbind(dat2tab,as.matrix(aggregate(ICES_VE$SI_LATI,by=list(ICES_VE$year),FUN=range)[,-1]))
colnames(dat2tab) <- c("Year", "min lon", "max lon", "min lat", "max lat")
kable(dat2tab)
```

## Area for which data has been submitted:
```{r area-of-data,  fig.height = 9}
polLand <- fortify(eurPols)
polLand <- subset(polLand, long >= spatBound$xrange[1] & long <= spatBound$xrange[2] &
                           lat >= spatBound$yrange[1] & lat  <= spatBound$yrange[2])
coordGrd <- unique(ICES_VE[, c("SI_LONG", "SI_LATI", "year")])

grdAll <- 
  lapply(1:nrow(coordGrd),
         function(i) {
           out <- list(SI_LONG = coordGrd[i, "SI_LONG"] + c(-1, 1, 1, -1) * 0.05/2,
                       SI_LATI = coordGrd[i, "SI_LATI"] + c(-1, -1, 1, 1) * 0.05/2)
           attr(out, "row.names") <- paste(1:4)
           attr(out, "class") <- "data.frame"
           out
         })
grdAll <- lonLat2SpatialPolygons(lst = grdAll)

polVMS <- fortify(grdAll)
polVMS$year <- rep(coordGrd$year,each=5)
polVMS$cols <- "red"

ggplot(polLand,aes(long,lat)) +
  geom_polygon(aes(group=group)) +
  coord_fixed(ratio=lonLatRatio(mean(spatBound$xrange),mean(spatBound$yrange)),xlim=spatBound$xrange, ylim=spatBound$yrange) +
  geom_polygon(data=polVMS,aes(long,lat,group=group,fill=cols)) +
  geom_polygon(data=polLand,aes(long,lat,group=group)) +
  facet_wrap(~year,ncol=2) +
  labs(x = "Longitude", y = "Latitude") +
  theme(axis.text.y   = element_text(colour="black"),
        axis.text.x   = element_text(colour="black"),
        axis.title.y  = element_text(size=14,face="bold"),
        axis.title.x  = element_text(size=14,face="bold"),
        legend.position = "none",
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Frequency of vessel length categories by year:
```{r records-by-vessel-length, results='asis'}
kable(table(ICES_VE$vessel_length_category,ICES_VE$year))

qplot(factor(year),data=ICES_VE, geom="bar",fill=factor(vessel_length_category)) +
      xlab("Years") + ylab ("Count") + 
      scale_fill_grey(guide=guide_legend(title="Length category")) +
      theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Frequency of gear codes by year:
```{r records-by-gear-code, results='asis'}
kable(table(ICES_VE$gear_code,ICES_VE$year))

qplot(factor(year),data=ICES_VE, geom="bar",fill=factor(gear_code)) +
  xlab("Years") + ylab ("Count") + scale_fill_grey(guide=guide_legend(title="Gear code")) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Spatial extend of 3 most dominant gears:
```{r spatial-extent-dominant-gears, results='asis', fig.height = 9}
top3gears <- orderBy(~x,data=aggregate(ICES_VE$fishing_hours,by=list(ICES_VE$gear_code),FUN=sum,na.rm=T))$Group.1[1:3]

polLand <- fortify(eurPols)
spatCore <- list(xrange = quantile(ICES_VE$SI_LONG, c(0.025, 0.975)),
                 yrange = quantile(ICES_VE$SI_LATI, c(0.025, 0.975)))
polLand <- subset(polLand, long >= spatCore$xrange[1] & long <= spatCore$xrange[2] &
                           lat >= spatCore$yrange[1] & lat  <= spatCore$yrange[2])
idx <- which(ICES_VE$gear_code %in% top3gears)
coordGrd <- unique(ICES_VE[idx,c("SI_LONG","SI_LATI","year","c_square","gear_code")])

grdAll <- 
  lapply(1:nrow(coordGrd),
         function(i) {
           out <- list(SI_LONG = coordGrd[i, "SI_LONG"] + c(-1, 1, 1, -1) * 0.05/2,
                       SI_LATI = coordGrd[i, "SI_LATI"] + c(-1, -1, 1, 1) * 0.05/2)
           attr(out, "row.names") <- paste(1:4)
           attr(out, "class") <- "data.frame"
           out
         })
grdAll <- lonLat2SpatialPolygons(lst = grdAll)

polVMS          <- fortify(grdAll)
polVMS$year     <- rep(coordGrd$year,each=5)
polVMS$c_square <- rep(coordGrd$c_square,each=5)
polVMS$gear_code<- rep(coordGrd$gear_code,each=5)
dat <- aggregate(ICES_VE$fishing_hours[idx],
                 by = list(ICES_VE$year[idx], ICES_VE$c_square[idx], ICES_VE$gear_code[idx]),
                 FUN = sum, na.rm = TRUE)

steps               <- ceiling(max(dat$x, na.rm=TRUE)/250/24)
cutbreaksval        <- c(-1,0,steps*c(1,2.5,5,10,25,50,100,250))
legval              <- outer(cutbreaksval, cutbreaksval, function(x,y) paste(x, "<=", y))
legval              <- c("0",diag(legval[-1,-c(1,2)]))
colintens           <- brewer.pal(length(cutbreaksval)-2,"YlOrRd")  #colour for fishing intensity
cols                <- c("white",colintens)[cut(dat$x/24,breaks=cutbreaksval)]
cols                <- cbind(cols,id=1:length(cols),year=dat$Group.1,c_square=dat$Group.2,gear_code=dat$Group.3)
polVMS              <- merge(polVMS,cols,by=c("year","c_square","gear_code"))

ggplot(polLand, aes(long, lat)) +
  geom_polygon(aes(group=group)) +
  coord_fixed(ratio = lonLatRatio(mean(spatCore$xrange), mean(spatCore$yrange)), 
              xlim = spatCore$xrange, ylim = spatCore$yrange) +
  guides(fill = guide_legend(title = "Days@Sea")) +
  geom_polygon(data = subset(polVMS, gear_code == top3gears[1]), 
               aes(long, lat, group = group, fill = cols)) +
  scale_fill_manual(values = c(colorRampPalette(rev(brewer.pal(length(cutbreaksval)-2, "YlOrRd")))(length(cutbreaksval)-2), "white"), 
                    labels = rev(legval)) +
  geom_polygon(data = subset(polVMS, gear_code == top3gears[1]), 
               aes(long, lat, group = group, fill = cols)) +
  geom_polygon(data = polLand, aes(long, lat, group = group)) +
  facet_wrap(~ year * gear_code, ncol = 2) +
  labs(x = "Longitude", y = "Latitude") +
  theme(axis.text.y   = element_text(colour="black"),
        axis.text.x   = element_text(colour="black"),
        axis.title.y  = element_text(size=14,face="bold"),
        axis.title.x  = element_text(size=14,face="bold"),
        legend.position="top",
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill = NA))
```

\newpage

```{r spatial-extent-dominant-gears2, results='asis', fig.height = 9}
ggplot(polLand,aes(long,lat)) +
  geom_polygon(aes(group=group)) +
  coord_fixed(ratio=lonLatRatio(mean(spatCore$xrange),mean(spatCore$yrange)),xlim=spatCore$xrange, ylim=spatCore$yrange) +
  guides(fill=guide_legend(title="Days@Sea")) +
  geom_polygon(data=subset(polVMS,gear_code==top3gears[2]),aes(long,lat,group=group,fill=cols)) +
  scale_fill_manual(values = c(colorRampPalette(rev(brewer.pal(length(cutbreaksval)-2,"YlOrRd")))(length(cutbreaksval)-2),"white"),labels=rev(legval)) +
  geom_polygon(data=subset(polVMS,gear_code==top3gears[2]),aes(long,lat,group=group,fill=cols)) +
  geom_polygon(data=polLand,aes(long,lat,group=group)) +
  facet_wrap(~year*gear_code,ncol=2) +
  labs(x = "Longitude", y = "Latitude") +
  theme(axis.text.y   = element_text(colour="black"),
        axis.text.x   = element_text(colour="black"),
        axis.title.y  = element_text(size=14,face="bold"),
        axis.title.x  = element_text(size=14,face="bold"),
        legend.position="top",
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage
        
```{r spatial-extent-dominant-gears3, results='asis', fig.height = 9}
ggplot(polLand,aes(long,lat)) +
  geom_polygon(aes(group=group)) +
  coord_fixed(ratio=lonLatRatio(mean(spatCore$xrange),mean(spatCore$yrange)),xlim=spatCore$xrange, ylim=spatCore$yrange) +
  guides(fill=guide_legend(title="Days@Sea")) +
  geom_polygon(data=subset(polVMS,gear_code==top3gears[3]),aes(long,lat,group=group,fill=cols)) +
  scale_fill_manual(values = c(colorRampPalette(rev(brewer.pal(length(cutbreaksval)-2,"YlOrRd")))(length(cutbreaksval)-2),"white"),labels=rev(legval)) +
  geom_polygon(data=subset(polVMS,gear_code==top3gears[3]),aes(long,lat,group=group,fill=cols)) +
  geom_polygon(data=polLand,aes(long,lat,group=group)) +
  facet_wrap(~year*gear_code,ncol=2) +
  labs(x = "Longitude", y = "Latitude") +
  theme(axis.text.y   = element_text(colour="black"),
        axis.text.x   = element_text(colour="black"),
        axis.title.y  = element_text(size=14,face="bold"),
        axis.title.x  = element_text(size=14,face="bold"),
        legend.position="top",
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage


## Number of unique DCF Level 6 codes by year:
```{r table-met6, results='asis'}
kable(count(unique(ICES_VE[,c("LE_MET_level6","year")]),"year"))
```

Top 5 DCF Level 6 codes by year:
```{r top5-met6} 
top5Met6 <- names(rev(sort(table(ICES_VE$LE_MET_level6)))[1:5])
kable(table(ICES_VE$LE_MET_level6,ICES_VE$year)[top5Met6,])

qplot(factor(year),data=subset(ICES_VE,LE_MET_level6 %in% top5Met6), geom="bar",fill=factor(LE_MET_level6)) +
  xlab("Years") + ylab ("Count") + scale_fill_grey(guide=guide_legend(title="Level 6")) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Average fishing speed:
```{r , results='asis'}
dat2plot  <- ICES_VE[,c("year","avg_fishing_speed")]
dat2plot$avg_fishing_speed <-  as.numeric(dat2plot$avg_fishing_speed)
ggplot(dat2plot,aes(x=avg_fishing_speed))+
  geom_histogram() +
  xlab("Average fishing speed") + ylab ("Count") +
  facet_wrap(~year,ncol=2) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Average fishing hours:
```{r Kw-hours}
dat2plot  <- ICES_VE[,c("year","fishing_hours")]
dat2plot$fishing_hours <-  as.numeric(dat2plot$fishing_hours)
ggplot(dat2plot,aes(x=fishing_hours))+
  geom_histogram() +
  xlab("Average fishing hours") + ylab ("Count") +
  facet_wrap(~year,ncol=2) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Average length:
```{r Kw}
dat2plot  <- ICES_VE[,c("year","avg_oal")]
dat2plot$avg_oal <-  as.numeric(dat2plot$avg_oal)
ggplot(dat2plot,aes(x=avg_oal))+
  geom_histogram() +
  xlab("Average vessel length") + ylab ("Count") +
  facet_wrap(~year,ncol=2) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Average KW:
```{r average-length}
dat2plot  <- ICES_VE[,c("year","avg_kw")]
dat2plot$avg_kw <-  as.numeric(dat2plot$avg_kw)
ggplot(dat2plot,aes(x=avg_kw))+
  geom_histogram() +
  xlab("Average vessel length") + ylab ("Count") +
  facet_wrap(~year,ncol=2) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Average KW-hours:
```{r fishing-speed}
dat2plot  <- ICES_VE[,c("year","kw_fishinghours")]
dat2plot$kw_fishinghours <-  as.numeric(dat2plot$kw_fishinghours)
ggplot(dat2plot,aes(x=kw_fishinghours))+
  geom_histogram() +
  xlab("Average KW-hours") + ylab ("Count") +
  facet_wrap(~year,ncol=2) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Landings by gear by year:
```{r fishing-hours}
dat2tab <- as.matrix(aggregate(ICES_VE$totweight,by=list(ICES_VE$year,ICES_VE$gear_code),FUN=sum))
colnames(dat2tab) <- c("Year","Gear_code","KG_landed")
dat2tab <- as.data.frame(orderBy(~Year,data=dat2tab),stringsAsFactors=F)
dat2tab$KG_landed <-  as.numeric(dat2tab$KG_landed)
dat2tab <- acast(dat2tab,Year ~ Gear_code,value.var="KG_landed")
kable(dat2tab)

dat2plot  <- melt(dat2tab)
colnames(dat2plot) <- c("Year","Gear_code","KG_landed")
dat2plot$cols      <-  as.numeric(af(dat2plot$Gear_code))

ggplot(dat2plot,aes(x=Year,y=KG_landed)) +
  geom_line(aes(group=Gear_code,colour=Gear_code),lwd=1.5) +
  xlab("Year") + ylab ("KG landed") +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Spatial distribution of effort by year:
```{r spatial-effort-year, results='asis', fig.height = 9}
polLand         <- fortify(eurPols)
spatCore        <- list(xrange=quantile(ICES_VE$SI_LONG,probs=c(0.025,0.975)),
                        yrange=quantile(ICES_VE$SI_LATI,probs=c(0.025,0.975)))
polLand         <- subset(polLand,long >= spatCore$xrange[1] & long <= spatCore$xrange[2] &
                                   lat >= spatCore$yrange[1] & lat  <= spatCore$yrange[2])
coordGrd        <- unique(ICES_VE[,c("SI_LONG","SI_LATI","year","c_square")])

grdAll <- 
  lapply(1:nrow(coordGrd),
         function(i) {
           out <- list(SI_LONG = coordGrd[i, "SI_LONG"] + c(-1, 1, 1, -1) * 0.05/2,
                       SI_LATI = coordGrd[i, "SI_LATI"] + c(-1, -1, 1, 1) * 0.05/2)
           attr(out, "row.names") <- paste(1:4)
           attr(out, "class") <- "data.frame"
           out
         })
grdAll <- lonLat2SpatialPolygons(lst = grdAll)

polVMS          <- fortify(grdAll)
polVMS$year     <- rep(coordGrd$year,each=5)
polVMS$c_square <- rep(coordGrd$c_square,each=5)
dat             <- aggregate(ICES_VE$fishing_hours,by=list(ICES_VE$year,ICES_VE$c_square),FUN=sum,na.rm=T)

steps               <- ceiling(max(dat$x,na.rm=T)/250/24)
cutbreaksval        <- c(-1, 0, steps * c(1,2.5,5,10,25,50,100,250))
legval <- paste(cutbreaksval[-length(cutbreaksval)], "<=", cutbreaksval[-1])
legval[1] <- "0"
colintens <- brewer.pal(length(cutbreaksval) - 2,"YlOrRd")  #colour for fishing intensity
cols <- c("white",colintens)[cut(dat$x/24,breaks=cutbreaksval)]
cols <- cbind(cols, id = 1:length(cols), c_square = dat$Group.2, year = dat$Group.1)
polVMS <- merge(polVMS, cols, by = c("c_square","year"))

ggplot(polLand,aes(long,lat)) +
  geom_polygon(aes(group=group)) +
  coord_fixed(ratio=lonLatRatio(mean(spatCore$xrange),mean(spatCore$yrange)),xlim=spatCore$xrange, ylim=spatCore$yrange) +
  guides(fill=guide_legend(title="Days@Sea")) +
  geom_polygon(data=polVMS,aes(long,lat,group=group,fill=cols)) +
  scale_fill_manual(values = c(colorRampPalette(rev(brewer.pal(length(cutbreaksval)-2,"YlOrRd")))(length(cutbreaksval)-2),"white"),labels=rev(legval)) +
  geom_polygon(data=polVMS,aes(long,lat,group=group,fill=cols)) +
  geom_polygon(data=polLand,aes(long,lat,group=group)) +
  facet_wrap(~year,ncol=2) +
  labs(x = "Longitude", y = "Latitude") +
  theme(axis.text.y   = element_text(colour="black"),
        axis.text.x   = element_text(colour="black"),
        axis.title.y  = element_text(size=14,face="bold"),
        axis.title.x  = element_text(size=14,face="bold"),
        legend.position="top",
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Spatial difference of effort `r tempBound[1]`:`r (tempBound[2]-1)` vs `r tempBound[2]`
```{r spatial-effort--difference1, results='asis', fig.height = 9}
base            <- subset(ICES_VE,year < (tempBound[2]-1))
recent          <- subset(ICES_VE,year == tempBound[2])
datbase         <- aggregate(base$fishing_hours,by=list(base$c_square,base$year),FUN=sum,na.rm=T)
datbase         <- aggregate(datbase$x,by=list(datbase$Group.1),FUN=median,na.rm=T)
datrecent       <- aggregate(recent$fishing_hours,by=list(recent$c_square),FUN=sum,na.rm=T)
colnames(datbase)    <- c("c_square","fishing_hours_median")
colnames(datrecent)   <- c("c_square","fishing_hours")
dat2plot        <- merge(datbase,datrecent[,c("c_square","fishing_hours")],by=c("c_square"),all=T)
dat2plot$fishing_hours_median[is.na(dat2plot$fishing_hours_median)] <- 0
dat2plot$fishing_hours[is.na(dat2plot$fishing_hours)] <- 0
dat2plot$ratio  <- log10(dat2plot$fishing_hours_median / dat2plot$fishing_hours)
dat2plot        <- cbind(dat2plot,CSquare2LonLat(dat2plot$c_square,degrees=0.05))
dat2plot$ratio[which(is.infinite(dat2plot$ratio) & dat2plot$fishing_hours == 0)] <- 9
dat2plot$ratio[which(is.infinite(dat2plot$ratio) & dat2plot$fishing_hours_median == 0)] <- -9
dat2plot$ratio[is.nan(dat2plot$ratio)] <- 0

grdAll <- 
  lapply(1:nrow(dat2plot),
         function(i) {
           out <- list(SI_LONG = dat2plot[i, "SI_LONG"] + c(-1, 1, 1, -1) * 0.05/2,
                       SI_LATI = dat2plot[i, "SI_LATI"] + c(-1, -1, 1, 1) * 0.05/2)
           attr(out, "row.names") <- paste(1:4)
           attr(out, "class") <- "data.frame"
           out
         })
grdAll <- lonLat2SpatialPolygons(lst = grdAll)

polVMS          <- fortify(grdAll)
polVMS$c_square <- rep(dat2plot$c_square,each=5)

cutbreaksval        <- log10(rev(c(1e-10,0.5,2/3,0.8,0.952381,1,1.05,1.25,1.5,2,1e10)))
legval              <- c("historic >>","historic> +100%","historic> +50%","historic> +25%","+/-5%","recent> +5%","recent> +25%","recent> +50%","recent> +100%","recent >>")
colintens           <- brewer.pal(length(cutbreaksval)-1,"RdYlBu")  #colour for fishing intensity
cols                <- colintens[cut(dat2plot$ratio,breaks=cutbreaksval)]
cols                <- cbind(cols,c_square=dat2plot$c_square)
polVMS              <- merge(polVMS,cols,by=c("c_square"))

ggplot(polLand,aes(long,lat)) +
  geom_polygon(aes(group=group)) +
  coord_fixed(ratio=lonLatRatio(mean(spatCore$xrange),mean(spatCore$yrange)),xlim=spatCore$xrange, ylim=spatCore$yrange) +
  guides(fill=guide_legend(title="Days@Sea")) +
  geom_polygon(data=polVMS,aes(long,lat,group=group,fill=cols)) +
  scale_fill_manual(values = colorRampPalette(rev(brewer.pal(length(cutbreaksval),"RdYlBu")))(length(cutbreaksval)-1),labels=legval) +
  geom_polygon(data=polVMS,aes(long,lat,group=group,fill=cols)) +
  geom_polygon(data=polLand,aes(long,lat,group=group)) +
  labs(x = "Longitude", y = "Latitude") +
  theme(axis.text.y   = element_text(colour="black"),
        axis.text.x   = element_text(colour="black"),
        axis.title.y  = element_text(size=14,face="bold"),
        axis.title.x  = element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Spatial difference of effort `r tempBound[2]-1` vs `r tempBound[2]`

```{r spatial-effort--difference2, results='asis', fig.height = 9}
base            <- subset(ICES_VE,year == (tempBound[2]-1))
recent          <- subset(ICES_VE,year == tempBound[2])
datbase         <- aggregate(base$fishing_hours,  by=list(base$c_square),  FUN=sum,na.rm=T)
datrecent       <- aggregate(recent$fishing_hours,by=list(recent$c_square),FUN=sum,na.rm=T)
colnames(datbase)    <- c("c_square","fishing_hours_median")
colnames(datrecent)   <- c("c_square","fishing_hours")
dat2plot        <- merge(datbase,datrecent[,c("c_square","fishing_hours")],by=c("c_square"),all=T)
dat2plot$fishing_hours_median[is.na(dat2plot$fishing_hours_median)] <- 0
dat2plot$fishing_hours[is.na(dat2plot$fishing_hours)] <- 0
dat2plot$ratio  <- log10(dat2plot$fishing_hours_median / dat2plot$fishing_hours)
dat2plot        <- cbind(dat2plot,CSquare2LonLat(dat2plot$c_square,degrees=0.05))
dat2plot$ratio[which(is.infinite(dat2plot$ratio) & dat2plot$fishing_hours == 0)] <- 9
dat2plot$ratio[which(is.infinite(dat2plot$ratio) & dat2plot$fishing_hours_median == 0)] <- -9
dat2plot$ratio[is.nan(dat2plot$ratio)] <- 0

grdAll <- 
  lapply(1:nrow(dat2plot),
         function(i) {
           out <- list(SI_LONG = dat2plot[i, "SI_LONG"] + c(-1, 1, 1, -1) * 0.05/2,
                       SI_LATI = dat2plot[i, "SI_LATI"] + c(-1, -1, 1, 1) * 0.05/2)
           attr(out, "row.names") <- paste(1:4)
           attr(out, "class") <- "data.frame"
           out
         })
grdAll <- lonLat2SpatialPolygons(lst = grdAll)

polVMS          <- fortify(grdAll)
polVMS$c_square <- rep(dat2plot$c_square,each=5)

cutbreaksval        <- log10(rev(c(1e-10,0.5,2/3,0.8,0.952381,1,1.05,1.25,1.5,2,1e10)))
legval              <- c("historic >>","historic> +100%","historic> +50%","historic> +25%","+/-5%","recent> +5%","recent> +25%","recent> +50%","recent> +100%","recent >>")
colintens           <- brewer.pal(length(cutbreaksval)-1,"RdYlBu")  #colour for fishing intensity
cols                <- colintens[cut(dat2plot$ratio,breaks=cutbreaksval)]
cols                <- cbind(cols,c_square=dat2plot$c_square)
polVMS              <- merge(polVMS,cols,by=c("c_square"))

ggplot(polLand,aes(long,lat)) +
  geom_polygon(aes(group=group)) +
  coord_fixed(ratio=lonLatRatio(mean(spatCore$xrange),mean(spatCore$yrange)),xlim=spatCore$xrange, ylim=spatCore$yrange) +
  guides(fill=guide_legend(title="Days@Sea")) +
  geom_polygon(data=polVMS,aes(long,lat,group=group,fill=cols)) +
  scale_fill_manual(values = colorRampPalette(rev(brewer.pal(length(cutbreaksval),"RdYlBu")))(length(cutbreaksval)-1),labels=legval) +
  geom_polygon(data=polVMS,aes(long,lat,group=group,fill=cols)) +
  geom_polygon(data=polLand,aes(long,lat,group=group)) +
  labs(x = "Longitude", y = "Latitude") +
  theme(axis.text.y   = element_text(colour="black"),
        axis.text.x   = element_text(colour="black"),
        axis.title.y  = element_text(size=14,face="bold"),
        axis.title.x  = element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Mean landing per KW fishing hours by year:

```{r landings-by-gear}
dat2tab <- as.matrix(aggregate(ICES_VE$totweight/ICES_VE$kw_fishinghours,by=list(ICES_VE$year,ICES_VE$gear_code),FUN=median))
colnames(dat2tab) <- c("Year","Gear_code","KGkwH")
dat2tab <- as.data.frame(orderBy(~Year,data=dat2tab),stringsAsFactors=F)
dat2tab$KGkwH <- as.numeric(dat2tab$KGkwH)
dat2tab <- acast(dat2tab,Year ~ Gear_code,value.var="KGkwH")
kable(dat2tab)

dat2plot  <- melt(dat2tab)
colnames(dat2plot) <- c("Year","Gear_code","KGkwH")
dat2plot$cols      <- as.numeric(af(dat2plot$Gear_code))

ggplot(dat2plot,aes(x=Year,y=KGkwH)) +
  geom_line(aes(group=Gear_code,colour=Gear_code),lwd=1.5) +
  xlab("Year") + ylab ("KG/kwH") +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Value by gear by year:
```{r value-by-gear-year, results='asis'}
dat2tab <- as.matrix(aggregate(ICES_VE$totvalue,by=list(ICES_VE$year,ICES_VE$gear_code),FUN=sum))
colnames(dat2tab) <- c("Year","Gear_code","EUR_landed")
dat2tab <- as.data.frame(orderBy(~Year,data=dat2tab),stringsAsFactors=F)
dat2tab$EUR_landed <- as.numeric(dat2tab$EUR_landed)
dat2tab <- acast(dat2tab,Year ~ Gear_code,value.var="EUR_landed")
kable(dat2tab)

dat2plot  <- melt(dat2tab)
colnames(dat2plot) <- c("Year","Gear_code","EUR_landed")
dat2plot$cols      <- as.numeric(af(dat2plot$Gear_code))

ggplot(dat2plot,aes(x=Year,y=EUR_landed)) +
  geom_line(aes(group=Gear_code,colour=Gear_code),lwd=1.5) +
  xlab("Year") + ylab ("EUR landed") +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Mean value per KW fishing hours by year:

```{r mean-value-by-KWhours-year, results='asis'}
dat2tab <- as.matrix(aggregate(ICES_VE$totvalue/ICES_VE$kw_fishinghours,by=list(ICES_VE$year,ICES_VE$gear_code),FUN=median))
colnames(dat2tab) <- c("Year","Gear_code","EURkwH")
dat2tab <- as.data.frame(orderBy(~Year,data=dat2tab),stringsAsFactors=F)
dat2tab$EURkwH <- as.numeric(dat2tab$EURkwH)
dat2tab <- acast(dat2tab,Year ~ Gear_code,value.var="EURkwH")
kable(dat2tab)

dat2plot  <- melt(dat2tab)
colnames(dat2plot) <- c("Year","Gear_code","EURkwH")
dat2plot$cols      <- as.numeric(af(dat2plot$Gear_code))

ggplot(dat2plot,aes(x=Year,y=EURkwH)) +
  geom_line(aes(group=Gear_code,colour=Gear_code),lwd=1.5) +
  xlab("Year") + ylab ("EUR/kwH") +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

##  Average price:

```{r price, results='asis'}
  dat2plot  <- aggregate(ICES_VE$totvalue/ICES_VE$totweight,by=list(ICES_VE$year),FUN=median)
  dat2plot$x <- as.numeric(dat2plot$x)
  colnames(dat2plot) <- c("Year","MeanPrice")
  ggplot(dat2plot,aes(x=Year,y=MeanPrice))+
    geom_line(lwd=1.5) +
    xlab("Year") + ylab ("EUR/kwH") +
    theme(axis.title=element_text(size=14,face="bold"),
          panel.background = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          axis.line = element_line(colour = "black"),
          panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

# Quality of the logbook

## Years & number of records for which data has been submitted:
```{r logbook-records, results='asis'}
kable(count(ICES_LE,'year'))

dat2plot <- data.frame(table(ICES_LE$year))
colnames(dat2plot) <- c("Year","Freq")
ggplot(dat2plot,aes(x=Year,y=Freq)) +
  geom_bar(stat="identity") + xlab("Year") + ylab("Number of records") +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              axis.line = element_line(colour = "black"),
              panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Distribution of pings by month:
```{r logbook-pings-month, results='asis'}
kable(table(ICES_LE$month,ICES_LE$year))

qplot(factor(year),data=ICES_LE, geom="bar",fill=factor(month)) +
  xlab("Years") + ylab ("Count") + scale_fill_grey(guide=guide_legend(title="Month")) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Area extend of data submitted by year:
```{r , results='asis', fig.height = 9}
dat2tab <- as.matrix(aggregate(ICES_LE$SI_LONG,by=list(ICES_LE$year),FUN=range))
dat2tab <- cbind(dat2tab,as.matrix(aggregate(ICES_LE$SI_LATI,by=list(ICES_LE$year),FUN=range)[,-1]))
colnames(dat2tab) <- c("Year","min lon","max lon","min lat","max lat")
kable(dat2tab)
```

## Area for which data has been submitted:
```{r , results='asis',fig.height = 9}
polLand         <- fortify(eurPols)
polLand         <- subset(polLand,long >= spatBoundLog$xrange[1] & long <= spatBoundLog$xrange[2] &
                                   lat >= spatBoundLog$yrange[1] & lat  <= spatBoundLog$yrange[2])
coordGrd        <- unique(ICES_LE[,c("SI_LONG","SI_LATI","year")])

grdAll <- 
  lapply(1:nrow(coordGrd),
         function(i) {
           out <- list(SI_LONG = coordGrd[i, "SI_LONG"] + c(-1, 1, 1, -1) * 1/2,
                       SI_LATI = coordGrd[i, "SI_LATI"] + c(-1, -1, 1, 1) * 1/2)
           attr(out, "row.names") <- paste(1:4)
           attr(out, "class") <- "data.frame"
           out
         })
grdAll <- lonLat2SpatialPolygons(lst = grdAll)

polRect         <- fortify(grdAll)
polRect$year    <- rep(coordGrd$year,each=5)
polRect$cols    <- "red"


ggplot(polLand,aes(long,lat)) +
  geom_polygon(aes(group=group)) +
  coord_fixed(ratio=lonLatRatio(mean(spatBoundLog$xrange),mean(spatBoundLog$yrange)),xlim=spatBoundLog$xrange, ylim=spatBoundLog$yrange) +
  geom_polygon(data=polRect,aes(long,lat,group=group,fill=cols)) +
  geom_polygon(data=polLand,aes(long,lat,group=group)) +
  facet_wrap(~year,ncol=2) +
  labs(x = "Longitude", y = "Latitude") +
  theme(axis.text.y   = element_text(colour="black"),
        axis.text.x   = element_text(colour="black"),
        axis.title.y  = element_text(size=14,face="bold"),
        axis.title.x  = element_text(size=14,face="bold"),
        legend.position = "none",
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Frequency of vessel length categories by year:
```{r , results='asis'}
kable(table(ICES_LE$vessel_length_category,ICES_LE$year))

qplot(factor(year),data=ICES_LE, geom="bar",fill=factor(vessel_length_category)) +
  xlab("Years") + ylab ("Count") + scale_fill_grey(guide=guide_legend(title="Length category")) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Frequency of gear codes by year:
```{r , results='asis'}
kable(table(ICES_LE$gear_code,ICES_LE$year))

qplot(factor(year),data=ICES_LE, geom="bar",fill=factor(gear_code)) +
  xlab("Years") + ylab ("Count") + scale_fill_grey(guide=guide_legend(title="Gear code")) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Number of unique DCF Level 6 codes by year:
```{r , results='asis'}
kable(count(unique(ICES_LE[,c("LE_MET_level6","year")]),"year"))
```

## Top 5 DCF Level 6 codes by year:
```{r , results='asis'}
top5Met6 <- names(rev(sort(table(ICES_LE$LE_MET_level6)))[1:5])
kable(table(ICES_LE$LE_MET_level6,ICES_LE$year)[top5Met6,])

qplot(factor(year),data=subset(ICES_LE,LE_MET_level6 %in% top5Met6), geom="bar",fill=factor(LE_MET_level6)) +
  xlab("Years") + ylab ("Count") + scale_fill_grey(guide=guide_legend(title="Level 6")) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Frequency of VMS enabled category
```{r , results='asis'}
kable(table(ICES_LE$vms_enabled,ICES_LE$vessel_length_category))
```

## Average fishing days:
```{r , results='asis'}
dat2plot  <- ICES_LE[,c("year","fishing_days")]
dat2plot$fishing_hours <- as.numeric(dat2plot$fishing_days)
ggplot(dat2plot,aes(x=fishing_days))+
  geom_histogram() +
  xlab("Average fishing days") + ylab ("Count") +
  facet_wrap(~year,ncol=2) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Average KW-hours:
```{r , results='asis'}
dat2plot  <- ICES_LE[,c("year","kw_fishing_days")]
dat2plot$kw_fishing_days <- as.numeric(dat2plot$kw_fishing_days)
ggplot(dat2plot,aes(x=kw_fishing_days))+
  geom_histogram() +
  xlab("Average KW-days") + ylab ("Count") +
  facet_wrap(~year,ncol=2) +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Landings by gear by year:
```{r , results='asis'}
dat2tab <- as.matrix(aggregate(ICES_LE$totweight,by=list(ICES_LE$year,ICES_LE$gear_code),FUN=sum))
colnames(dat2tab) <- c("Year","Gear_code","KG_landed")
dat2tab <- as.data.frame(orderBy(~Year,data=dat2tab),stringsAsFactors=F)
dat2tab$KG_landed <- as.numeric(dat2tab$KG_landed)
dat2tab <- acast(dat2tab,Year ~ Gear_code,value.var="KG_landed")
kable(dat2tab)

dat2plot  <- melt(dat2tab)
colnames(dat2plot) <- c("Year","Gear_code","KG_landed")
dat2plot$cols      <- as.numeric(af(dat2plot$Gear_code))

ggplot(dat2plot,aes(x=Year,y=KG_landed)) +
  geom_line(aes(group=Gear_code,colour=Gear_code),lwd=1.5) +
  xlab("Year") + ylab ("KG landed") +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Spatial distribution of effort by year:
```{r , results='asis', fig.height = 9}
polLand         <- fortify(eurPols)
spatCore        <- list(xrange=quantile(ICES_LE$SI_LONG,probs=c(0.025,0.975)),
                        yrange=quantile(ICES_LE$SI_LATI,probs=c(0.025,0.975)))
polLand         <- subset(polLand,long >= spatCore$xrange[1] & long <= spatCore$xrange[2] &
                                   lat >= spatCore$yrange[1] & lat  <= spatCore$yrange[2])
coordGrd        <- unique(ICES_LE[,c("SI_LONG","SI_LATI","year","ICES_rectangle")])

grdAll <- 
  lapply(1:nrow(coordGrd),
         function(i) {
           out <- list(SI_LONG = coordGrd[i, "SI_LONG"] + c(-1, 1, 1, -1) * 1/2,
                       SI_LATI = coordGrd[i, "SI_LATI"] + c(-1, -1, 1, 1) * 1/2)
           attr(out, "row.names") <- paste(1:4)
           attr(out, "class") <- "data.frame"
           out
         })
grdAll <- lonLat2SpatialPolygons(lst = grdAll)

polRect         <- fortify(grdAll)
polRect$year    <- rep(coordGrd$year,each=5)
polRect$ICES_rectangle <- rep(coordGrd$ICES_rectangle,each=5)
dat             <- aggregate(ICES_LE$fishing_days,by=list(ICES_LE$year,ICES_LE$ICES_rectangle),FUN=sum,na.rm=T)

steps               <- ceiling(max(dat$x,na.rm=T)/250)
cutbreaksval        <- c(-1,0,steps*c(1,2.5,5,10,25,50,100,250))
legval              <- outer(ac(cutbreaksval),ac(cutbreaksval),function(x,y){return(paste(x,"<=",y))})
legval              <- c("0",diag(legval[-1,-c(1,2)]))
colintens           <- brewer.pal(length(cutbreaksval)-2,"YlOrRd")  #colour for fishing intensity
cols                <- c("white",colintens)[cut(dat$x,breaks=cutbreaksval)]
cols                <- cbind(cols,id=1:length(cols),ICES_rectangle=dat$Group.2,year=dat$Group.1)
polRect              <- merge(polRect,cols,by=c("ICES_rectangle","year"))

ggplot(polLand,aes(long,lat)) +
  geom_polygon(aes(group=group)) +
  coord_fixed(ratio=lonLatRatio(mean(spatCore$xrange),mean(spatCore$yrange)),xlim=spatCore$xrange, ylim=spatCore$yrange) +
  guides(fill=guide_legend(title="Days@Sea")) +
  geom_polygon(data=polRect,aes(long,lat,group=group,fill=cols)) +
  scale_fill_manual(values = c(colorRampPalette(rev(brewer.pal(length(cutbreaksval)-2,"YlOrRd")))(length(cutbreaksval)-2),"white"),labels=rev(legval)) +
  geom_polygon(data=polRect,aes(long,lat,group=group,fill=cols)) +
  geom_polygon(data=polLand,aes(long,lat,group=group)) +
  facet_wrap(~year,ncol=2) +
  labs(x = "Longitude", y = "Latitude") +
  theme(axis.text.y   = element_text(colour="black"),
        axis.text.x   = element_text(colour="black"),
        axis.title.y  = element_text(size=14,face="bold"),
        axis.title.x  = element_text(size=14,face="bold"),
        legend.position="top",
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Spatial difference of effort `r tempBound[1]`:`r (tempBound[2]-1)` vs `r tempBound[2]`
```{r , results='asis'}
base            <- subset(ICES_LE,year < (tempBoundLog[2]-1))
recent          <- subset(ICES_LE,year == tempBoundLog[2])
datbase         <- aggregate(base$fishing_days,by=list(base$ICES_rectangle,base$year),FUN=sum,na.rm=T)
datbase         <- aggregate(datbase$x,by=list(datbase$Group.1),FUN=median,na.rm=T)
datrecent       <- aggregate(recent$fishing_days,by=list(recent$ICES_rectangle),FUN=sum,na.rm=T)
colnames(datbase)    <- c("ICES_rectangle","fishing_days_median")
colnames(datrecent)   <- c("ICES_rectangle","fishing_days")
dat2plot        <- merge(datbase,datrecent[,c("ICES_rectangle","fishing_days")],by=c("ICES_rectangle"),all=T)
dat2plot$fishing_days_median[is.na(dat2plot$fishing_days_median)] <- 0
dat2plot$fishing_days[is.na(dat2plot$fishing_days)] <- 0
dat2plot$ratio  <- log10(dat2plot$fishing_days_median / dat2plot$fishing_days)
dat2plot        <- cbind(dat2plot,ICESrectangle2LonLat(dat2plot$ICES_rectangle,midpoint=T))
dat2plot$ratio[which(is.infinite(dat2plot$ratio) & dat2plot$fishing_days == 0)] <- 9
dat2plot$ratio[which(is.infinite(dat2plot$ratio) & dat2plot$fishing_days_median == 0)] <- -9
dat2plot$ratio[is.nan(dat2plot$ratio)] <- 0

grdAll <- 
  lapply(1:nrow(dat2plot),
         function(i) {
           out <- list(SI_LONG = dat2plot[i, "SI_LONG"] + c(-1, 1, 1, -1) * 1/2,
                       SI_LATI = dat2plot[i, "SI_LATI"] + c(-1, -1, 1, 1) * 1/2)
           attr(out, "row.names") <- paste(1:4)
           attr(out, "class") <- "data.frame"
           out
         })
grdAll <- lonLat2SpatialPolygons(lst = grdAll)

polRect          <- fortify(grdAll)
polRect$ICES_rectangle <- rep(dat2plot$ICES_rectangle,each=5)

cutbreaksval        <- log10(rev(c(1e-10,0.5,2/3,0.8,0.952381,1,1.05,1.25,1.5,2,1e10)))
legval              <- c("historic >>","historic> +100%","historic> +50%","historic> +25%","+/-5%","recent> +5%","recent> +25%","recent> +50%","recent> +100%","recent >>")
colintens           <- brewer.pal(length(cutbreaksval)-1,"RdYlBu")  #colour for fishing intensity
cols                <- colintens[cut(dat2plot$ratio,breaks=cutbreaksval)]
cols                <- cbind(cols,ICES_rectangle=dat2plot$ICES_rectangle)
polRect              <- merge(polRect,cols,by=c("ICES_rectangle"))

  ggplot(polLand,aes(long,lat)) +
    geom_polygon(aes(group=group)) +
    coord_fixed(ratio=lonLatRatio(mean(spatCore$xrange),mean(spatCore$yrange)),xlim=spatCore$xrange, ylim=spatCore$yrange) +
    guides(fill=guide_legend(title="Days@Sea")) +
    geom_polygon(data=polRect,aes(long,lat,group=group,fill=cols)) +
    scale_fill_manual(values = colorRampPalette(rev(brewer.pal(length(cutbreaksval),"RdYlBu")))(length(cutbreaksval)-1),labels=legval) +
    geom_polygon(data=polRect,aes(long,lat,group=group,fill=cols)) +
    geom_polygon(data=polLand,aes(long,lat,group=group)) +
    labs(x = "Longitude", y = "Latitude") +
    theme(axis.text.y   = element_text(colour="black"),
          axis.text.x   = element_text(colour="black"),
          axis.title.y  = element_text(size=14,face="bold"),
          axis.title.x  = element_text(size=14,face="bold"),
          panel.background = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          axis.line = element_line(colour = "black"),
          panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Spatial difference of effort `r tempBound[2]-1` vs `r tempBound[2]`

```{r , results='asis'}
base            <- subset(ICES_LE,year == (tempBoundLog[2]-1))
recent          <- subset(ICES_LE,year == tempBoundLog[2])
datbase         <- aggregate(base$fishing_days,  by=list(base$ICES_rectangle),  FUN=sum,na.rm=T)
datrecent       <- aggregate(recent$fishing_days,by=list(recent$ICES_rectangle),FUN=sum,na.rm=T)
colnames(datbase)    <- c("ICES_rectangle","fishing_days_median")
colnames(datrecent)   <- c("ICES_rectangle","fishing_days")
dat2plot        <- merge(datbase,datrecent[,c("ICES_rectangle","fishing_days")],by=c("ICES_rectangle"),all=T)
dat2plot$fishing_days_median[is.na(dat2plot$fishing_days_median)] <- 0
dat2plot$fishing_days[is.na(dat2plot$fishing_days)] <- 0
dat2plot$ratio  <- log10(dat2plot$fishing_days_median / dat2plot$fishing_days)
dat2plot        <- cbind(dat2plot,ICESrectangle2LonLat(dat2plot$ICES_rectangle,midpoint=T))
dat2plot$ratio[which(is.infinite(dat2plot$ratio) & dat2plot$fishing_days == 0)] <- 9
dat2plot$ratio[which(is.infinite(dat2plot$ratio) & dat2plot$fishing_days_median == 0)] <- -9
dat2plot$ratio[is.nan(dat2plot$ratio)] <- 0

grdAll <- 
  lapply(1:nrow(dat2plot),
         function(i) {
           out <- list(SI_LONG = dat2plot[i, "SI_LONG"] + c(-1, 1, 1, -1) * 1/2,
                       SI_LATI = dat2plot[i, "SI_LATI"] + c(-1, -1, 1, 1) * 1/2)
           attr(out, "row.names") <- paste(1:4)
           attr(out, "class") <- "data.frame"
           out
         })
grdAll <- lonLat2SpatialPolygons(lst = grdAll)

polRect          <- fortify(grdAll)
polRect$ICES_rectangle <- rep(dat2plot$ICES_rectangle,each=5)

cutbreaksval        <- log10(rev(c(1e-10,0.5,2/3,0.8,0.952381,1,1.05,1.25,1.5,2,1e10)))
legval              <- c("historic >>","historic> +100%","historic> +50%","historic> +25%","+/-5%","recent> +5%","recent> +25%","recent> +50%","recent> +100%","recent >>")
colintens           <- brewer.pal(length(cutbreaksval)-1,"RdYlBu")  #colour for fishing intensity
cols                <- colintens[cut(dat2plot$ratio,breaks=cutbreaksval)]
cols                <- cbind(cols,ICES_rectangle=dat2plot$ICES_rectangle)
polRect              <- merge(polRect,cols,by=c("ICES_rectangle"))

ggplot(polLand,aes(long,lat)) +
  geom_polygon(aes(group=group)) +
  coord_fixed(ratio=lonLatRatio(mean(spatCore$xrange),mean(spatCore$yrange)),xlim=spatCore$xrange, ylim=spatCore$yrange) +
  guides(fill=guide_legend(title="Days@Sea")) +
  geom_polygon(data=polRect,aes(long,lat,group=group,fill=cols)) +
  scale_fill_manual(values = colorRampPalette(rev(brewer.pal(length(cutbreaksval),"RdYlBu")))(length(cutbreaksval)-1),labels=legval) +
  geom_polygon(data=polRect,aes(long,lat,group=group,fill=cols)) +
  geom_polygon(data=polLand,aes(long,lat,group=group)) +
  labs(x = "Longitude", y = "Latitude") +
  theme(axis.text.y   = element_text(colour="black"),
        axis.text.x   = element_text(colour="black"),
        axis.title.y  = element_text(size=14,face="bold"),
        axis.title.x  = element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage


## Relationship fishing days and total weight
```{r , results='asis'}
ggplot(subset(ICES_LE,year==tempBoundLog[2]),aes(x=fishing_days,y=totweight)) +
  geom_point() +
  facet_wrap(~gear_code,ncol=2,scale="free") +
  xlab("Fishing days") + ylab ("Total weight") +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Mean landing per KW fishing day by year:

```{r , results='asis'}
ICES_LE$kw_fishing_days <- as.numeric(ICES_LE$kw_fishing_days)
dat2tab <- as.matrix(aggregate(ICES_LE$totweight/ICES_LE$kw_fishing_days,by=list(ICES_LE$year,ICES_LE$gear_code),FUN=median))
colnames(dat2tab) <- c("Year","Gear_code","KGkwH")
dat2tab <- as.data.frame(orderBy(~Year,data=dat2tab),stringsAsFactors=F)
dat2tab$KGkwH <- as.numeric(dat2tab$KGkwH)
dat2tab <- acast(dat2tab,Year ~ Gear_code,value.var="KGkwH")
kable(dat2tab)

dat2plot  <- melt(dat2tab)
colnames(dat2plot) <- c("Year","Gear_code","KGkwH")
dat2plot$cols      <- as.numeric(af(dat2plot$Gear_code))

ggplot(dat2plot,aes(x=Year,y=KGkwH)) +
  geom_line(aes(group=Gear_code,colour=Gear_code),lwd=1.5) +
  xlab("Year") + ylab ("KG/kwH") +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Value by gear by year:
```{r , results='asis'}
ICES_LE$totvalue <- as.numeric(ICES_LE$totvalue)
dat2tab <- as.matrix(aggregate(ICES_LE$totvalue,by=list(ICES_LE$year,ICES_LE$gear_code),FUN=sum))
colnames(dat2tab) <- c("Year","Gear_code","EUR_landed")
dat2tab <- as.data.frame(orderBy(~Year,data=dat2tab),stringsAsFactors=F)
dat2tab$EUR_landed <- as.numeric(dat2tab$EUR_landed)
dat2tab <- acast(dat2tab,Year ~ Gear_code,value.var="EUR_landed")
kable(dat2tab)

dat2plot  <- melt(dat2tab)
colnames(dat2plot) <- c("Year","Gear_code","EUR_landed")
dat2plot$cols      <- as.numeric(af(dat2plot$Gear_code))

ggplot(dat2plot,aes(x=Year,y=EUR_landed)) +
  geom_line(aes(group=Gear_code,colour=Gear_code),lwd=1.5) +
  xlab("Year") + ylab ("EUR landed") +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

## Mean value per KW fishing day by year:

```{r , results='asis'}
dat2tab <- as.matrix(aggregate(ICES_LE$totvalue/ICES_LE$kw_fishing_days,by=list(ICES_LE$year,ICES_LE$gear_code),FUN=median))
colnames(dat2tab) <- c("Year","Gear_code","EURkwH")
dat2tab <- as.data.frame(orderBy( ~ Year, data = dat2tab), stringsAsFactors = FALSE)
dat2tab$EURkwH <- as.numeric(dat2tab$EURkwH)
dat2tab <- acast(dat2tab, Year ~ Gear_code, value.var = "EURkwH")
kable(dat2tab)

dat2plot  <- melt(dat2tab)
colnames(dat2plot) <- c("Year","Gear_code","EURkwH")
dat2plot$cols      <- as.numeric(af(dat2plot$Gear_code))

ggplot(dat2plot,aes(x=Year,y=EURkwH)) +
  geom_line(aes(group=Gear_code,colour=Gear_code),lwd=1.5) +
  xlab("Year") + ylab ("EUR/kwH") +
  theme(axis.title=element_text(size=14,face="bold"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(colour = "black", fill=NA))
```

\newpage

##  Average price:

```{r , results='asis'}
  dat2plot  <- aggregate(ICES_LE$totvalue/ICES_LE$totweight,by=list(ICES_LE$year),FUN=median)
  dat2plot$x <- as.numeric(dat2plot$x)
  colnames(dat2plot) <- c("Year","MeanPrice")
  ggplot(dat2plot,aes(x=Year,y=MeanPrice))+
    geom_line(lwd=1.5) +
    xlab("Year") + ylab ("EUR/kwH") +
    theme(axis.title=element_text(size=14,face="bold"),
          panel.background = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          axis.line = element_line(colour = "black"),
          panel.border = element_rect(colour = "black", fill=NA))
```


